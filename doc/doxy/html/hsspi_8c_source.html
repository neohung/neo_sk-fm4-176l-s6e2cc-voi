<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>PDL for FM Family: C:/Users/chzhang/Desktop/FM0 MCU/universial PDL/release_v11f_doxy/driver/hsspi/hsspi.c Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>


</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  <td id="projectlogo"><img alt="Logo" src="products_site_image.png"/></td>
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">PDL for FM Family
   &#160;<span id="projectnumber">Version2.0.0</span>
   </div>
   <div id="projectbrief">FM Peripheral Driver Library</div>
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('hsspi_8c.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">C:/Users/chzhang/Desktop/FM0 MCU/universial PDL/release_v11f_doxy/driver/hsspi/hsspi.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="hsspi_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/******************************************************************************</span>
<a name="l00002"></a>00002 <span class="comment">* Copyright (C) 2015 Spansion LLC. All Rights Reserved. </span>
<a name="l00003"></a>00003 <span class="comment">*</span>
<a name="l00004"></a>00004 <span class="comment">* This software is owned and published by: </span>
<a name="l00005"></a>00005 <span class="comment">* Spansion LLC, 915 DeGuigne Dr. Sunnyvale, CA  94088-3453 (&quot;Spansion&quot;).</span>
<a name="l00006"></a>00006 <span class="comment">*</span>
<a name="l00007"></a>00007 <span class="comment">* BY DOWNLOADING, INSTALLING OR USING THIS SOFTWARE, YOU AGREE TO BE BOUND </span>
<a name="l00008"></a>00008 <span class="comment">* BY ALL THE TERMS AND CONDITIONS OF THIS AGREEMENT.</span>
<a name="l00009"></a>00009 <span class="comment">*</span>
<a name="l00010"></a>00010 <span class="comment">* This software contains source code for use with Spansion </span>
<a name="l00011"></a>00011 <span class="comment">* components. This software is licensed by Spansion to be adapted only </span>
<a name="l00012"></a>00012 <span class="comment">* for use in systems utilizing Spansion components. Spansion shall not be </span>
<a name="l00013"></a>00013 <span class="comment">* responsible for misuse or illegal use of this software for devices not </span>
<a name="l00014"></a>00014 <span class="comment">* supported herein.  Spansion is providing this software &quot;AS IS&quot; and will </span>
<a name="l00015"></a>00015 <span class="comment">* not be responsible for issues arising from incorrect user implementation </span>
<a name="l00016"></a>00016 <span class="comment">* of the software.  </span>
<a name="l00017"></a>00017 <span class="comment">*</span>
<a name="l00018"></a>00018 <span class="comment">* SPANSION MAKES NO WARRANTY, EXPRESS OR IMPLIED, ARISING BY LAW OR OTHERWISE,</span>
<a name="l00019"></a>00019 <span class="comment">* REGARDING THE SOFTWARE (INCLUDING ANY ACOOMPANYING WRITTEN MATERIALS), </span>
<a name="l00020"></a>00020 <span class="comment">* ITS PERFORMANCE OR SUITABILITY FOR YOUR INTENDED USE, INCLUDING, </span>
<a name="l00021"></a>00021 <span class="comment">* WITHOUT LIMITATION, THE IMPLIED WARRANTY OF MERCHANTABILITY, THE IMPLIED </span>
<a name="l00022"></a>00022 <span class="comment">* WARRANTY OF FITNESS FOR A PARTICULAR PURPOSE OR USE, AND THE IMPLIED </span>
<a name="l00023"></a>00023 <span class="comment">* WARRANTY OF NONINFRINGEMENT.  </span>
<a name="l00024"></a>00024 <span class="comment">* SPANSION SHALL HAVE NO LIABILITY (WHETHER IN CONTRACT, WARRANTY, TORT, </span>
<a name="l00025"></a>00025 <span class="comment">* NEGLIGENCE OR OTHERWISE) FOR ANY DAMAGES WHATSOEVER (INCLUDING, WITHOUT </span>
<a name="l00026"></a>00026 <span class="comment">* LIMITATION, DAMAGES FOR LOSS OF BUSINESS PROFITS, BUSINESS INTERRUPTION, </span>
<a name="l00027"></a>00027 <span class="comment">* LOSS OF BUSINESS INFORMATION, OR OTHER PECUNIARY LOSS) ARISING FROM USE OR </span>
<a name="l00028"></a>00028 <span class="comment">* INABILITY TO USE THE SOFTWARE, INCLUDING, WITHOUT LIMITATION, ANY DIRECT, </span>
<a name="l00029"></a>00029 <span class="comment">* INDIRECT, INCIDENTAL, SPECIAL OR CONSEQUENTIAL DAMAGES OR LOSS OF DATA, </span>
<a name="l00030"></a>00030 <span class="comment">* SAVINGS OR PROFITS, </span>
<a name="l00031"></a>00031 <span class="comment">* EVEN IF SPANSION HAS BEEN ADVISED OF THE POSSIBILITY OF SUCH DAMAGES. </span>
<a name="l00032"></a>00032 <span class="comment">* YOU ASSUME ALL RESPONSIBILITIES FOR SELECTION OF THE SOFTWARE TO ACHIEVE YOUR</span>
<a name="l00033"></a>00033 <span class="comment">* INTENDED RESULTS, AND FOR THE INSTALLATION OF, USE OF, AND RESULTS OBTAINED </span>
<a name="l00034"></a>00034 <span class="comment">* FROM, THE SOFTWARE.  </span>
<a name="l00035"></a>00035 <span class="comment">*</span>
<a name="l00036"></a>00036 <span class="comment">* This software may be replicated in part or whole for the licensed use, </span>
<a name="l00037"></a>00037 <span class="comment">* with the restriction that this Disclaimer and Copyright notice must be </span>
<a name="l00038"></a>00038 <span class="comment">* included with each copy of this software, whether used in part or whole, </span>
<a name="l00039"></a>00039 <span class="comment">* at all times.</span>
<a name="l00040"></a>00040 <span class="comment">******************************************************************************/</span>
<a name="l00041"></a>00041 <span class="comment">/*****************************************************************************/</span>
<a name="l00051"></a>00051 <span class="comment">/*****************************************************************************/</span>
<a name="l00052"></a>00052 <span class="comment">/* Include files                                                             */</span>
<a name="l00053"></a>00053 <span class="comment">/*****************************************************************************/</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;<a class="code" href="hsspi_8h.html">hsspi.h</a>&quot;</span>
<a name="l00055"></a>00055 
<a name="l00056"></a>00056 <span class="preprocessor">#if (defined(PDL_PERIPHERAL_HSSPI_ACTIVE))</span>
<a name="l00057"></a>00057 <span class="preprocessor"></span>
<a name="l00063"></a>00063 
<a name="l00064"></a>00064 <span class="comment">/*****************************************************************************/</span>
<a name="l00065"></a>00065 <span class="comment">/* Local pre-processor symbols/macros (&#39;define&#39;)                             */</span>
<a name="l00066"></a>00066 <span class="comment">/*****************************************************************************/</span>
<a name="l00071"></a><a class="code" href="group___hs_spi_group.html#gab176ed4b683a2e6e88ea789352119f44">00071</a> <span class="preprocessor">#define HS_SPI_MAX_FIFO_DEPTH         (16u)</span>
<a name="l00072"></a>00072 <span class="preprocessor"></span>
<a name="l00079"></a><a class="code" href="group___hs_spi_group.html#ga4270126336e68b080d629031d01d2fa9">00079</a> <span class="preprocessor">#define HSSPI_DIRECT_MODE_TX_RX_SINGLE_MODE    (0x0u)    ///&lt; Transmit and receive in single mode.</span>
<a name="l00080"></a><a class="code" href="group___hs_spi_group.html#gaad97f47759a78297820d374a3218c252">00080</a> <span class="preprocessor"></span><span class="preprocessor">#define HSSPI_DIRECT_MODE_RX_ONLY_SINGLE_MODE  (0x4u)    ///&lt; Receive only, in single mode</span>
<a name="l00081"></a><a class="code" href="group___hs_spi_group.html#ga744f67cb02ea6a857f2d9456847f6708">00081</a> <span class="preprocessor"></span><span class="preprocessor">#define HSSPI_DIRECT_MODE_RX_ONLY_DUAL_MODE    (0x5u)    ///&lt; Receive only, in dual mode</span>
<a name="l00082"></a><a class="code" href="group___hs_spi_group.html#ga39d0835a2cee67d26cd6b2c3db326d2e">00082</a> <span class="preprocessor"></span><span class="preprocessor">#define HSSPI_DIRECT_MODE_RX_ONLY_QUAD_MODE    (0x6u)    ///&lt; Receive only, in quad mode</span>
<a name="l00083"></a><a class="code" href="group___hs_spi_group.html#ga5b38151bd5ad8b5ac5075314eb8bba0d">00083</a> <span class="preprocessor"></span><span class="preprocessor">#define HSSPI_DIRECT_MODE_TX_ONLY_SINGLE_MODE  (0x8u)    ///&lt; Transmit only, in single mode. </span>
<a name="l00084"></a><a class="code" href="group___hs_spi_group.html#ga56628311f82938c7ab8fb203c018d967">00084</a> <span class="preprocessor"></span><span class="preprocessor">#define HSSPI_DIRECT_MODE_TX_ONLY_DUAL_MODE    (0x9u)    ///&lt; Transmit only, in dual mode.</span>
<a name="l00085"></a><a class="code" href="group___hs_spi_group.html#gaa90edc3bf16fde0cbfdc2293ad194e86">00085</a> <span class="preprocessor"></span><span class="preprocessor">#define HSSPI_DIRECT_MODE_TX_ONLY_QUAD_MODE    (0xAu)    ///&lt; Transmit only, in quad mode.</span>
<a name="l00086"></a>00086 <span class="preprocessor"></span>
<a name="l00087"></a>00087 <span class="comment">/*****************************************************************************/</span>
<a name="l00088"></a>00088 <span class="comment">/* Global variable definitions (declared in header file with &#39;extern&#39;)       */</span>
<a name="l00089"></a>00089 <span class="comment">/*****************************************************************************/</span>
<a name="l00090"></a>00090 
<a name="l00092"></a><a class="code" href="group___hs_spi_group.html#gac71686f090257bc8e250785d8e42b4f2">00092</a> <a class="code" href="structstc__hsspi__instance__data.html" title="HS-SPI instance data type.">stc_hsspi_instance_data_t</a> <a class="code" href="group___hs_spi_group.html#gac71686f090257bc8e250785d8e42b4f2" title="Look-up table for all enabled I2S instances and their internal data.">m_astcHsSpiInstanceDataLut</a>[<a class="code" href="group___hs_spi_group.html#ga0f6337fcda0fab16b9dd1ed43325618d">HS_SPI_INSTANCE_COUNT</a>] =
<a name="l00093"></a>00093 {
<a name="l00094"></a>00094 <span class="preprocessor">  #if (PDL_PERIPHERAL_ENABLE_HSSPI0 == PDL_ON)</span>
<a name="l00095"></a>00095 <span class="preprocessor"></span>  { 
<a name="l00096"></a>00096      &amp;<a class="code" href="group___hs_spi_group.html#gac016eacecc2ddfcbfab358c16d3b31d0">HSSPI0</a>,   <span class="comment">// pstcInstance</span>
<a name="l00097"></a>00097      0u,
<a name="l00098"></a>00098      {0u, 0u, 0u, 0u, 0u, <a class="code" href="group___hs_spi_group.html#gga52d2086b160266357f91b0cbdaf46a09a72003fc564e9ba9812d184041601d3d6" title="Serial clock low during idle, data output set with falling clock edge, data input sampling with risin...">HsSpiClkLowOutFallingInRising</a>, <a class="code" href="group___hs_spi_group.html#gga68f85282c3247934fd7adad845483c60a468d5e1331e433ffa681e83ca6ef797a" title="Single mode.">HsSpiProtocolModeSingle</a>, 0u}   <span class="comment">// stcInternData (not initialized yet)</span>
<a name="l00099"></a>00099   }
<a name="l00100"></a>00100 <span class="preprocessor">  #endif</span>
<a name="l00101"></a>00101 <span class="preprocessor"></span>};
<a name="l00102"></a>00102 
<a name="l00103"></a>00103 <span class="comment">/*****************************************************************************/</span>
<a name="l00104"></a>00104 <span class="comment">/* Global variable definitions (declared in header file with &#39;extern&#39;)       */</span>
<a name="l00105"></a>00105 <span class="comment">/*****************************************************************************/</span>
<a name="l00106"></a>00106 
<a name="l00107"></a>00107 <span class="comment">/*****************************************************************************/</span>
<a name="l00108"></a>00108 <span class="comment">/* Local type definitions (&#39;typedef&#39;)                                        */</span>
<a name="l00109"></a>00109 <span class="comment">/*****************************************************************************/</span>
<a name="l00110"></a>00110 
<a name="l00111"></a>00111 <span class="comment">/*****************************************************************************/</span>
<a name="l00112"></a>00112 <span class="comment">/* Local variable definitions (&#39;static&#39;)                                     */</span>
<a name="l00113"></a>00113 <span class="comment">/*****************************************************************************/</span>
<a name="l00114"></a>00114 
<a name="l00115"></a>00115 <span class="comment">/*****************************************************************************/</span>
<a name="l00116"></a>00116 <span class="comment">/* Local function prototypes (&#39;static&#39;)                                      */</span>
<a name="l00117"></a>00117 <span class="comment">/*****************************************************************************/</span>
<a name="l00118"></a>00118 <span class="keyword">static</span> en_result_t <a class="code" href="group___hs_spi_group.html#gacffe258666aff8b6d4d2d29ddab17253" title="Globally enable SPI module by setting bit MEN.">HsSpi_ModuleEnable</a> (<span class="keyword">volatile</span> <a class="code" href="group___hs_spi_group.html#gabf9239d572714b9709b8b01844dfe84f">stc_hsspin_t</a>* pstcHsSpi);
<a name="l00119"></a>00119 <span class="keyword">static</span> en_result_t <a class="code" href="group___hs_spi_group.html#ga14b83b69bca9c376d382ea131ccbc98b" title="Globally disable HS-SPI module by clearing bit MEN.">HsSpi_ModuleDisable</a>(<span class="keyword">volatile</span> <a class="code" href="group___hs_spi_group.html#gabf9239d572714b9709b8b01844dfe84f">stc_hsspin_t</a>* pstcHsSpi);
<a name="l00120"></a>00120 
<a name="l00121"></a>00121 <span class="comment">/*****************************************************************************/</span>
<a name="l00122"></a>00122 <span class="comment">/* Function implementation - global (&#39;extern&#39;) and local (&#39;static&#39;)          */</span>
<a name="l00123"></a>00123 <span class="comment">/*****************************************************************************/</span>
<a name="l00124"></a>00124 
<a name="l00134"></a><a class="code" href="group___hs_spi_group.html#ga075c13e0ec20570f5dce624c7daac457">00134</a> <span class="keyword">static</span> <a class="code" href="structstc__hsspi__intern__data.html" title="HS-SPI instance internal data, storing internal information for each enabled HS-SPI instance...">stc_hsspi_intern_data_t</a>* <a class="code" href="group___hs_spi_group.html#ga075c13e0ec20570f5dce624c7daac457" title="Return the internal data for a certain HS-SPI instance.">HsSpiGetInternDataPtr</a>(<span class="keyword">volatile</span> <a class="code" href="group___hs_spi_group.html#gabf9239d572714b9709b8b01844dfe84f">stc_hsspin_t</a>* pstcHsSpi) 
<a name="l00135"></a>00135 {
<a name="l00136"></a>00136     uint8_t u8Instance;
<a name="l00137"></a>00137    
<a name="l00138"></a>00138     <span class="keywordflow">for</span> (u8Instance = 0u; u8Instance &lt; <a class="code" href="group___hs_spi_group.html#ga0f6337fcda0fab16b9dd1ed43325618d">HS_SPI_INSTANCE_COUNT</a>; u8Instance++)
<a name="l00139"></a>00139     {
<a name="l00140"></a>00140         <span class="keywordflow">if</span> (pstcHsSpi == m_astcHsSpiInstanceDataLut[u8Instance].pstcInstance)
<a name="l00141"></a>00141         {
<a name="l00142"></a>00142             <span class="keywordflow">return</span> &amp;m_astcHsSpiInstanceDataLut[u8Instance].<a class="code" href="structstc__hsspi__instance__data.html#aa5eead39568a6bc7dc846be1bc9e5046" title="module internal data of instance">stcInternData</a>;
<a name="l00143"></a>00143         }
<a name="l00144"></a>00144     }
<a name="l00145"></a>00145 
<a name="l00146"></a>00146     <span class="keywordflow">return</span> NULL;
<a name="l00147"></a>00147 }
<a name="l00148"></a>00148 
<a name="l00159"></a><a class="code" href="group___hs_spi_group.html#gacffe258666aff8b6d4d2d29ddab17253">00159</a> <span class="keyword">static</span> en_result_t <a class="code" href="group___hs_spi_group.html#gacffe258666aff8b6d4d2d29ddab17253" title="Globally enable SPI module by setting bit MEN.">HsSpi_ModuleEnable</a>(<span class="keyword">volatile</span> <a class="code" href="group___hs_spi_group.html#gabf9239d572714b9709b8b01844dfe84f">stc_hsspin_t</a>* pstcHsSpi)
<a name="l00160"></a>00160 {
<a name="l00161"></a>00161     uint32_t u32TimeOut;
<a name="l00162"></a>00162     u32TimeOut = 100000000u;
<a name="l00163"></a>00163     
<a name="l00164"></a>00164     <span class="keywordflow">if</span>(NULL == pstcHsSpi)
<a name="l00165"></a>00165     {
<a name="l00166"></a>00166         <span class="keywordflow">return</span> Error;
<a name="l00167"></a>00167     }
<a name="l00168"></a>00168     
<a name="l00169"></a>00169     <span class="comment">// Set module enable bit in module control register.</span>
<a name="l00170"></a>00170     pstcHsSpi-&gt;MCTRL_f.MEN = 1u;
<a name="l00171"></a>00171 
<a name="l00172"></a>00172     <span class="comment">// Wait until module enable status bit is set by hardware</span>
<a name="l00173"></a>00173     <span class="keywordflow">while</span> ((0u == pstcHsSpi-&gt;MCTRL_f.MES) &amp;&amp; (u32TimeOut &gt; 0u))
<a name="l00174"></a>00174     {
<a name="l00175"></a>00175         <a class="code" href="group___p_d_l.html#ga76336ac37d977e02bf0fdbf84b1e3fd1" title="Hook function, which is called in polling loops.">PDL_WAIT_LOOP_HOOK</a>();
<a name="l00176"></a>00176         u32TimeOut--;
<a name="l00177"></a>00177     }
<a name="l00178"></a>00178     
<a name="l00179"></a>00179     <span class="keywordflow">if</span>(0ul == u32TimeOut)
<a name="l00180"></a>00180     {
<a name="l00181"></a>00181       <span class="keywordflow">return</span> ErrorTimeout;
<a name="l00182"></a>00182     }
<a name="l00183"></a>00183     
<a name="l00184"></a>00184     <span class="keywordflow">return</span> Ok;
<a name="l00185"></a>00185 } <span class="comment">// HsSpiModuleEnable</span>
<a name="l00186"></a>00186 
<a name="l00196"></a><a class="code" href="group___hs_spi_group.html#ga14b83b69bca9c376d382ea131ccbc98b">00196</a> <span class="keyword">static</span> en_result_t <a class="code" href="group___hs_spi_group.html#ga14b83b69bca9c376d382ea131ccbc98b" title="Globally disable HS-SPI module by clearing bit MEN.">HsSpi_ModuleDisable</a>(<span class="keyword">volatile</span> <a class="code" href="group___hs_spi_group.html#gabf9239d572714b9709b8b01844dfe84f">stc_hsspin_t</a>* pstcHsSpi)
<a name="l00197"></a>00197 {
<a name="l00198"></a>00198     uint32_t u32TimeOut;
<a name="l00199"></a>00199     u32TimeOut = 100000000u;
<a name="l00200"></a>00200     
<a name="l00201"></a>00201     <span class="keywordflow">if</span>(NULL == pstcHsSpi)
<a name="l00202"></a>00202     {
<a name="l00203"></a>00203         <span class="keywordflow">return</span> Error;
<a name="l00204"></a>00204     }
<a name="l00205"></a>00205     
<a name="l00206"></a>00206     <span class="comment">// Clear module enable bit in module control register.</span>
<a name="l00207"></a>00207     pstcHsSpi-&gt;MCTRL_f.MEN = 0u;
<a name="l00208"></a>00208 
<a name="l00209"></a>00209     <span class="comment">// Wait until module enable status bit is reset by hardware...</span>
<a name="l00210"></a>00210     <span class="keywordflow">while</span> ((0u != pstcHsSpi-&gt;MCTRL_f.MES) &amp;&amp; (u32TimeOut &gt; 0u))
<a name="l00211"></a>00211     {
<a name="l00212"></a>00212         <a class="code" href="group___p_d_l.html#ga76336ac37d977e02bf0fdbf84b1e3fd1" title="Hook function, which is called in polling loops.">PDL_WAIT_LOOP_HOOK</a>();
<a name="l00213"></a>00213         u32TimeOut--;
<a name="l00214"></a>00214     }
<a name="l00215"></a>00215     
<a name="l00216"></a>00216     <span class="keywordflow">if</span>(0ul == u32TimeOut)
<a name="l00217"></a>00217     {
<a name="l00218"></a>00218       <span class="keywordflow">return</span> Error;
<a name="l00219"></a>00219     }
<a name="l00220"></a>00220     
<a name="l00221"></a>00221     <span class="keywordflow">return</span> Ok;
<a name="l00222"></a>00222 } <span class="comment">// HsSpiModuleDisable</span>
<a name="l00223"></a>00223 
<a name="l00244"></a><a class="code" href="group___hs_spi_group.html#ga7581afad372733fb4b809bf82cad43b7">00244</a> en_result_t <a class="code" href="group___hs_spi_group.html#ga7581afad372733fb4b809bf82cad43b7" title="Initialisation of the HS-SPI module. FIFO width is limited to 8 bit and DMA is not supported in direc...">HsSpi_Init</a>(<span class="keyword">volatile</span> <a class="code" href="group___hs_spi_group.html#gabf9239d572714b9709b8b01844dfe84f">stc_hsspin_t</a>* pstcHsSpi, <span class="keyword">const</span> <a class="code" href="structstc__hsspi__config.html" title="(High speed) SPI configuration.">stc_hsspi_config_t</a>* pstcConfig)
<a name="l00245"></a>00245 {
<a name="l00246"></a>00246     <a class="code" href="structstc__hsspi__intern__data.html" title="HS-SPI instance internal data, storing internal information for each enabled HS-SPI instance...">stc_hsspi_intern_data_t</a>* pstcHsSpiInternData;                       <span class="comment">// Pointer to internal data</span>
<a name="l00247"></a>00247     stc_hsspi_cscfg_field_t  stcCSCFG;
<a name="l00248"></a>00248     en_result_t enResult;
<a name="l00249"></a>00249     
<a name="l00250"></a>00250     <a class="code" href="pdl_8h.html#abb9020d4207202ccd19e6a2f34c5d559">PDL_ZERO_STRUCT</a>(stcCSCFG);
<a name="l00251"></a>00251     
<a name="l00252"></a>00252     <span class="comment">// Check for NULL-Pointers</span>
<a name="l00253"></a>00253     <span class="keywordflow">if</span> (NULL == pstcHsSpi ||
<a name="l00254"></a>00254         NULL == pstcConfig
<a name="l00255"></a>00255        )
<a name="l00256"></a>00256     {
<a name="l00257"></a>00257         <span class="keywordflow">return</span> ErrorInvalidParameter;
<a name="l00258"></a>00258     }
<a name="l00259"></a>00259 
<a name="l00260"></a>00260     <span class="comment">// Check for Threshold in Range</span>
<a name="l00261"></a>00261     <span class="keywordflow">if</span> (pstcConfig-&gt;<a class="code" href="structstc__hsspi__config.html#a763f2487f261236e8e5067c55f3a98b8" title="Possible values from 0 to 15 (maximum FIFO depth is 16).">u8TxFifoThresholdLow</a> &gt; (<a class="code" href="group___hs_spi_group.html#gab176ed4b683a2e6e88ea789352119f44" title="Transmit and receive maximum FIFO depth.">HS_SPI_MAX_FIFO_DEPTH</a> - 1u))
<a name="l00262"></a>00262     {
<a name="l00263"></a>00263         <span class="keywordflow">return</span> ErrorInvalidParameter;
<a name="l00264"></a>00264     }
<a name="l00265"></a>00265 
<a name="l00266"></a>00266     <span class="comment">// Get ptr to internal data struct ...</span>
<a name="l00267"></a>00267     pstcHsSpiInternData = <a class="code" href="group___hs_spi_group.html#ga075c13e0ec20570f5dce624c7daac457" title="Return the internal data for a certain HS-SPI instance.">HsSpiGetInternDataPtr</a>(pstcHsSpi);
<a name="l00268"></a>00268     <span class="comment">// ... and check</span>
<a name="l00269"></a>00269     <span class="keywordflow">if</span> (NULL == pstcHsSpiInternData)
<a name="l00270"></a>00270     {
<a name="l00271"></a>00271         <span class="keywordflow">return</span> ErrorInvalidParameter;
<a name="l00272"></a>00272     }
<a name="l00273"></a>00273 
<a name="l00274"></a>00274     <span class="comment">// Just to ensure, Everything is switched off</span>
<a name="l00275"></a>00275     enResult = <a class="code" href="group___hs_spi_group.html#ga14b83b69bca9c376d382ea131ccbc98b" title="Globally disable HS-SPI module by clearing bit MEN.">HsSpi_ModuleDisable</a>(pstcHsSpi);
<a name="l00276"></a>00276     <span class="comment">//.... Check if operation timed out</span>
<a name="l00277"></a>00277     <span class="keywordflow">if</span>(Ok != enResult)
<a name="l00278"></a>00278     {
<a name="l00279"></a>00279       <span class="keywordflow">return</span> Error;
<a name="l00280"></a>00280     }
<a name="l00281"></a>00281 
<a name="l00282"></a>00282     <span class="comment">// Release STOP bit</span>
<a name="l00283"></a>00283     pstcHsSpi-&gt;DMSTOP = 0x00u;                                   <span class="comment">// .STOP = 0;</span>
<a name="l00284"></a>00284 
<a name="l00285"></a>00285     <span class="comment">// Store callback functions to intern data struct.</span>
<a name="l00286"></a>00286     pstcHsSpiInternData-&gt;<a class="code" href="structstc__hsspi__intern__data.html#a2a33cf5ed480693b0adb053623d67d22">pfnTxStatusCallbackFunction</a> = pstcConfig-&gt;<a class="code" href="structstc__hsspi__config.html#a1086c858c7adb4c2f7ecaf5ba7c41e2c" title="Callback function for transmission status.">pfnTxStatusCallback</a>;
<a name="l00287"></a>00287 
<a name="l00288"></a>00288     <span class="comment">// Reset direct mode DMA enable register.</span>
<a name="l00289"></a>00289     pstcHsSpi-&gt;DMDMAEN = 0x00u;                                  <span class="comment">// Rx and Tx DMA disabled</span>
<a name="l00290"></a>00290 
<a name="l00291"></a>00291     <span class="comment">// Save protocol mode</span>
<a name="l00292"></a>00292     pstcHsSpiInternData-&gt;<a class="code" href="structstc__hsspi__intern__data.html#a296445f6fdf4c711614117336229d98b">enDirectModeProtocol</a> = pstcConfig-&gt;<a class="code" href="structstc__hsspi__config.html#a296445f6fdf4c711614117336229d98b" title="See description of en_hsspi_protocol_mode_t.">enDirectModeProtocol</a>;
<a name="l00293"></a>00293 
<a name="l00294"></a>00294     <span class="comment">// Save operation mode</span>
<a name="l00295"></a>00295     pstcHsSpiInternData-&gt;<a class="code" href="structstc__hsspi__intern__data.html#a0adddabbd359200339ec25017ffa772b">bMasterOperation</a> = pstcConfig-&gt;<a class="code" href="structstc__hsspi__config.html#a0adddabbd359200339ec25017ffa772b" title="TRUE: selects HS-SPI interface operates in Master Mode (default), FALSE: operating in Slave mode (onl...">bMasterOperation</a>;
<a name="l00296"></a>00296 
<a name="l00297"></a>00297     <span class="comment">// Set prescaler</span>
<a name="l00298"></a>00298     <span class="keywordflow">switch</span>(pstcConfig-&gt;<a class="code" href="structstc__hsspi__config.html#a6adb45014eccd4979ee3cccfce443fb6" title="See description of en_hsspi_clk_divider_t.">enClockDivider</a>)
<a name="l00299"></a>00299     {
<a name="l00300"></a>00300       <span class="keywordflow">case</span> <a class="code" href="group___hs_spi_group.html#gga142e4bea2f501508a73550b92288054ca968823912b8a0ec2c441ff4ea5459c97" title="Clock divider is 1.">HsSpiClkDividerDiv1</a>:
<a name="l00301"></a>00301         pstcHsSpi-&gt;QDCLKR_f.QHDIV = 0x00u;
<a name="l00302"></a>00302         <span class="keywordflow">break</span>;
<a name="l00303"></a>00303       <span class="keywordflow">case</span> <a class="code" href="group___hs_spi_group.html#gga142e4bea2f501508a73550b92288054caa7c6fa08324a9dddc32afec5b9896aee" title="Clock divider is 2.">HsSpiClkDividerDiv2</a>:
<a name="l00304"></a>00304         pstcHsSpi-&gt;QDCLKR_f.QHDIV = 0x01u;
<a name="l00305"></a>00305         <span class="keywordflow">break</span>;
<a name="l00306"></a>00306       <span class="keywordflow">case</span> <a class="code" href="group___hs_spi_group.html#gga142e4bea2f501508a73550b92288054ca5e5683d6f37516e8c56ec662640fa12b" title="Clock divider is 3.">HsSpiClkDividerDiv3</a>:
<a name="l00307"></a>00307         pstcHsSpi-&gt;QDCLKR_f.QHDIV = 0x02u;
<a name="l00308"></a>00308         <span class="keywordflow">break</span>;
<a name="l00309"></a>00309       <span class="keywordflow">case</span> <a class="code" href="group___hs_spi_group.html#gga142e4bea2f501508a73550b92288054caf2ab0296502dfacc582f8a594a59fdda" title="Clock divider is 4.">HsSpiClkDividerDiv4</a>:
<a name="l00310"></a>00310         pstcHsSpi-&gt;QDCLKR_f.QHDIV = 0x03u;
<a name="l00311"></a>00311         <span class="keywordflow">break</span>;
<a name="l00312"></a>00312       <span class="keywordflow">case</span> <a class="code" href="group___hs_spi_group.html#gga142e4bea2f501508a73550b92288054ca333370cbf23ab7c05fd9ed0b2a8f3825" title="Clock divider is 5.">HsSpiClkDividerDiv5</a>:
<a name="l00313"></a>00313         pstcHsSpi-&gt;QDCLKR_f.QHDIV = 0x04u;
<a name="l00314"></a>00314         <span class="keywordflow">break</span>;
<a name="l00315"></a>00315       <span class="keywordflow">case</span> <a class="code" href="group___hs_spi_group.html#gga142e4bea2f501508a73550b92288054ca9d6d8eae44c0dad82ef3b10b03981698" title="Clock divider is 6.">HsSpiClkDividerDiv6</a>:
<a name="l00316"></a>00316         pstcHsSpi-&gt;QDCLKR_f.QHDIV = 0x05u;
<a name="l00317"></a>00317         <span class="keywordflow">break</span>;
<a name="l00318"></a>00318       <span class="keywordflow">case</span> <a class="code" href="group___hs_spi_group.html#gga142e4bea2f501508a73550b92288054ca0c66e7bcf7f2044b33355c1028f0e0f3" title="Clock divider is 7.">HsSpiClkDividerDiv7</a>:
<a name="l00319"></a>00319         pstcHsSpi-&gt;QDCLKR_f.QHDIV = 0x06u;
<a name="l00320"></a>00320         <span class="keywordflow">break</span>;
<a name="l00321"></a>00321       <span class="keywordflow">case</span> <a class="code" href="group___hs_spi_group.html#gga142e4bea2f501508a73550b92288054ca6c38d4e51f8e119916dde13506482648" title="Clock divider is 8.">HsSpiClkDividerDiv8</a>:
<a name="l00322"></a>00322         pstcHsSpi-&gt;QDCLKR_f.QHDIV = 0x07u;
<a name="l00323"></a>00323         <span class="keywordflow">break</span>;
<a name="l00324"></a>00324       <span class="keywordflow">case</span> <a class="code" href="group___hs_spi_group.html#gga142e4bea2f501508a73550b92288054ca82e49929d56774f2b5b09ebe091a84e6" title="Clock divider is 9.">HsSpiClkDividerDiv9</a>:
<a name="l00325"></a>00325         pstcHsSpi-&gt;QDCLKR_f.QHDIV = 0x08u;
<a name="l00326"></a>00326         <span class="keywordflow">break</span>;
<a name="l00327"></a>00327       <span class="keywordflow">case</span> <a class="code" href="group___hs_spi_group.html#gga142e4bea2f501508a73550b92288054cabf3d6860cef52e0ec91a0b95f70c7e12" title="Clock divider is 10.">HsSpiClkDividerDiv10</a>:
<a name="l00328"></a>00328         pstcHsSpi-&gt;QDCLKR_f.QHDIV = 0x09u;
<a name="l00329"></a>00329         <span class="keywordflow">break</span>;
<a name="l00330"></a>00330       <span class="keywordflow">case</span> <a class="code" href="group___hs_spi_group.html#gga142e4bea2f501508a73550b92288054ca90612dc36be80818fb30a43628d69289" title="Clock divider is 11.">HsSpiClkDividerDiv11</a>:
<a name="l00331"></a>00331         pstcHsSpi-&gt;QDCLKR_f.QHDIV = 0x0Au;
<a name="l00332"></a>00332         <span class="keywordflow">break</span>;
<a name="l00333"></a>00333       <span class="keywordflow">case</span> <a class="code" href="group___hs_spi_group.html#gga142e4bea2f501508a73550b92288054cade719afc2e28eecb0d5acb19bd147ae1" title="Clock divider is 12.">HsSpiClkDividerDiv12</a>:
<a name="l00334"></a>00334         pstcHsSpi-&gt;QDCLKR_f.QHDIV = 0x0Bu;
<a name="l00335"></a>00335         <span class="keywordflow">break</span>;
<a name="l00336"></a>00336       <span class="keywordflow">case</span> <a class="code" href="group___hs_spi_group.html#gga142e4bea2f501508a73550b92288054cab683e38e9cbcd696435e040d808acbdd" title="Clock divider is 13.">HsSpiClkDividerDiv13</a>:
<a name="l00337"></a>00337         pstcHsSpi-&gt;QDCLKR_f.QHDIV = 0x0Cu;
<a name="l00338"></a>00338         <span class="keywordflow">break</span>;
<a name="l00339"></a>00339       <span class="keywordflow">case</span> <a class="code" href="group___hs_spi_group.html#gga142e4bea2f501508a73550b92288054ca5288f66a5f076b365e64c357c2eda141" title="Clock divider is 14.">HsSpiClkDividerDiv14</a>:
<a name="l00340"></a>00340         pstcHsSpi-&gt;QDCLKR_f.QHDIV = 0x0Du;
<a name="l00341"></a>00341         <span class="keywordflow">break</span>;
<a name="l00342"></a>00342       <span class="keywordflow">case</span> <a class="code" href="group___hs_spi_group.html#gga142e4bea2f501508a73550b92288054caffc8a0bf59b392720134f6279bca40bf" title="Clock divider is 15.">HsSpiClkDividerDiv15</a>:
<a name="l00343"></a>00343         pstcHsSpi-&gt;QDCLKR_f.QHDIV = 0x0Eu;
<a name="l00344"></a>00344         <span class="keywordflow">break</span>;
<a name="l00345"></a>00345       <span class="keywordflow">case</span> <a class="code" href="group___hs_spi_group.html#gga142e4bea2f501508a73550b92288054caa85ad228edab31c30337c89930e6ac90" title="Clock divider is 16.">HsSpiClkDividerDiv16</a>:
<a name="l00346"></a>00346         pstcHsSpi-&gt;QDCLKR_f.QHDIV = 0x0Fu;
<a name="l00347"></a>00347         <span class="keywordflow">break</span>;
<a name="l00348"></a>00348       <span class="keywordflow">default</span>:
<a name="l00349"></a>00349         <span class="keywordflow">return</span> ErrorInvalidParameter;
<a name="l00350"></a>00350     }
<a name="l00351"></a>00351     
<a name="l00352"></a>00352     <span class="comment">// Just a default (will be setup by the transfer function)</span>
<a name="l00353"></a>00353     pstcHsSpi-&gt;DMTRP = (uint8_t)pstcConfig-&gt;<a class="code" href="structstc__hsspi__config.html#a296445f6fdf4c711614117336229d98b" title="See description of en_hsspi_protocol_mode_t.">enDirectModeProtocol</a>;
<a name="l00354"></a>00354 
<a name="l00355"></a>00355     <span class="comment">// Set direct mode configuration register.</span>
<a name="l00356"></a>00356     pstcHsSpi-&gt;DMCFG_f.SSDC     = 1u;                                   <span class="comment">// Slave Select Deassert is controlled by DMBCC:BCC</span>
<a name="l00357"></a>00357 
<a name="l00358"></a>00358     <span class="comment">// Reset direct mode byte count control register.</span>
<a name="l00359"></a>00359     pstcHsSpi-&gt;DMBCC = 1u;
<a name="l00360"></a>00360 
<a name="l00361"></a>00361     <span class="comment">// Set FIFO configuration register.</span>
<a name="l00362"></a>00362     pstcHsSpi-&gt;FIFOCFG_f.FWIDTH = pstcConfig-&gt;<a class="code" href="structstc__hsspi__config.html#ac6f18294c2fc7e3ec78d0cab0cf222ba" title="See description of en_hsspi_fifo_width.">enFifoWidth</a>;               <span class="comment">// FIFO width</span>
<a name="l00363"></a>00363     pstcHsSpi-&gt;FIFOCFG_f.RXFTH  = 0x7u; <span class="comment">// RX FIFO threshold</span>
<a name="l00364"></a>00364     pstcHsSpi-&gt;FIFOCFG_f.TXFTH  = pstcConfig-&gt;<a class="code" href="structstc__hsspi__config.html#a763f2487f261236e8e5067c55f3a98b8" title="Possible values from 0 to 15 (maximum FIFO depth is 16).">u8TxFifoThresholdLow</a>;      <span class="comment">// TX FIFO threshold</span>
<a name="l00365"></a>00365     
<a name="l00366"></a>00366     <span class="comment">// Reset command sequencer address extension register.</span>
<a name="l00367"></a>00367     pstcHsSpi-&gt;CSAEXT = 0x00ul;
<a name="l00368"></a>00368       
<a name="l00369"></a>00369     <span class="comment">// Set command sequencer idle time register.</span>
<a name="l00370"></a>00370     pstcHsSpi-&gt;CSITIME = (uint32_t)pstcConfig-&gt;<a class="code" href="structstc__hsspi__config.html#ae2bb60ecdcea8ee34d489f64f208fddd" title="The idle timeout interval is in terms of the AHB clock period. Slave select will stay asserted for th...">u16IdleTimeOut</a>;
<a name="l00371"></a>00371 
<a name="l00372"></a>00372     <span class="comment">// Set command sequencer configuration register.</span>
<a name="l00373"></a>00373     stcCSCFG.SSEL3EN = 0u;                                                      <span class="comment">// Disable access to slave select 3 memory</span>
<a name="l00374"></a>00374     stcCSCFG.SSEL2EN = 0u;                                                      <span class="comment">// Disable access to slave select 2 memory</span>
<a name="l00375"></a>00375     stcCSCFG.SSEL1EN = 0u;                                                      <span class="comment">// Disable access to slave select 1 memory</span>
<a name="l00376"></a>00376     stcCSCFG.SSEL0EN = 0u;                                                      <span class="comment">// Disable access to slave select 0 memory</span>
<a name="l00377"></a>00377     <span class="comment">//stcCSCFG.SSEL0EN = 1u;                                                      // Enable access to slave select 0 memory</span>
<a name="l00378"></a>00378     stcCSCFG.MSEL    = pstcConfig-&gt;<a class="code" href="structstc__hsspi__config.html#a2e3ddebde51b526ea6c56e53cadba552" title="See description of en_hsspi_bank_size_t.">enMemoryBankSize</a>;                            <span class="comment">// Range of the AHB address space associated with each slave select line</span>
<a name="l00379"></a>00379     stcCSCFG.MBM     = pstcConfig-&gt;<a class="code" href="structstc__hsspi__config.html#a366292faf83cbfc9661fa04af00cbddb" title="See description of en_hsspi_protocol_mode_t.">enCommandSequencerModeProtocol</a>;              <span class="comment">// Multi bit mode</span>
<a name="l00380"></a>00380     stcCSCFG.SRAM    = pstcConfig-&gt;<a class="code" href="structstc__hsspi__config.html#a4d1e1fe5e5b58955d83e1b443b1847cc" title="See description of en_hsspi_memory_type_t.">enMemoryType</a>;                                <span class="comment">// Serial Flash or SRAM device</span>
<a name="l00381"></a>00381 
<a name="l00382"></a>00382     pstcHsSpi-&gt;CSCFG_f = stcCSCFG;                                       <span class="comment">// Save to register</span>
<a name="l00383"></a>00383     
<a name="l00384"></a>00384     <span class="comment">// Set TX/RX DMA bridge</span>
<a name="l00385"></a>00385     pstcHsSpi-&gt;DBCNT_f.TXDBEN = (TRUE == pstcConfig-&gt;<a class="code" href="structstc__hsspi__config.html#a3c1eeba3c4115328dd5d99cc8af4f6b8" title="TRUE: enables TX DMA bridge, FALSE: disable TX DMA bridge.">bTxDmaBridgeEnable</a>) ? 1u : 0u;
<a name="l00386"></a>00386     pstcHsSpi-&gt;DBCNT_f.RXDBEN = (TRUE == pstcConfig-&gt;<a class="code" href="structstc__hsspi__config.html#a5d9e96f823ecbd00eab3d723ac4e494f" title="TRUE: enables RX DMA bridge, FALSE: disable RX DMA bridge.">bRxDmaBridgeEnable</a>) ? 1u : 0u;
<a name="l00387"></a>00387 
<a name="l00388"></a>00388     enResult = <a class="code" href="group___hs_spi_group.html#gacffe258666aff8b6d4d2d29ddab17253" title="Globally enable SPI module by setting bit MEN.">HsSpi_ModuleEnable</a>(pstcHsSpi);                                   <span class="comment">// Now switch module on</span>
<a name="l00389"></a>00389     <span class="comment">//.... Check if operation timed out</span>
<a name="l00390"></a>00390     <span class="keywordflow">if</span>(Ok != enResult)
<a name="l00391"></a>00391     {
<a name="l00392"></a>00392       <span class="keywordflow">return</span> Error;
<a name="l00393"></a>00393     }
<a name="l00394"></a>00394     
<a name="l00395"></a>00395     <span class="keywordflow">return</span> Ok;
<a name="l00396"></a>00396 } <span class="comment">// HsSpi_Init</span>
<a name="l00397"></a>00397 
<a name="l00413"></a><a class="code" href="group___hs_spi_group.html#ga2146b960638ccba840f7424684e7070c">00413</a> en_result_t <a class="code" href="group___hs_spi_group.html#ga2146b960638ccba840f7424684e7070c" title="De-Initializes the HS-SPI unit. All registers which are used by HS-SPI will be reset to their default...">HsSpi_DeInit</a>(<span class="keyword">volatile</span> <a class="code" href="group___hs_spi_group.html#gabf9239d572714b9709b8b01844dfe84f">stc_hsspin_t</a>* pstcHsSpi)
<a name="l00414"></a>00414 {
<a name="l00415"></a>00415     <a class="code" href="structstc__hsspi__intern__data.html" title="HS-SPI instance internal data, storing internal information for each enabled HS-SPI instance...">stc_hsspi_intern_data_t</a>* pstcHsSpiInternData; <span class="comment">// Pointer to internal data</span>
<a name="l00416"></a>00416     en_result_t enResult;
<a name="l00417"></a>00417     
<a name="l00418"></a>00418     <span class="comment">// Check for NULL-Pointer</span>
<a name="l00419"></a>00419     <span class="keywordflow">if</span> (NULL == pstcHsSpi)
<a name="l00420"></a>00420     {
<a name="l00421"></a>00421         <span class="keywordflow">return</span> ErrorInvalidParameter;
<a name="l00422"></a>00422     }
<a name="l00423"></a>00423 
<a name="l00424"></a>00424     <span class="comment">// Get ptr to internal data struct ...</span>
<a name="l00425"></a>00425     pstcHsSpiInternData = <a class="code" href="group___hs_spi_group.html#ga075c13e0ec20570f5dce624c7daac457" title="Return the internal data for a certain HS-SPI instance.">HsSpiGetInternDataPtr</a>(pstcHsSpi);
<a name="l00426"></a>00426     <span class="comment">// ... and check</span>
<a name="l00427"></a>00427     <span class="keywordflow">if</span> (NULL == pstcHsSpiInternData)
<a name="l00428"></a>00428     {
<a name="l00429"></a>00429         <span class="keywordflow">return</span> ErrorInvalidParameter;
<a name="l00430"></a>00430     }
<a name="l00431"></a>00431 
<a name="l00432"></a>00432     <span class="comment">// Stop any transfer and de-assert slave.</span>
<a name="l00433"></a>00433     pstcHsSpi-&gt;DMSTOP = 0x01u; <span class="comment">// STOP = 1;</span>
<a name="l00434"></a>00434 
<a name="l00435"></a>00435     <span class="comment">// Just to ensure, anything is switched off</span>
<a name="l00436"></a>00436     enResult = <a class="code" href="group___hs_spi_group.html#ga14b83b69bca9c376d382ea131ccbc98b" title="Globally disable HS-SPI module by clearing bit MEN.">HsSpi_ModuleDisable</a>(pstcHsSpi);                                  
<a name="l00437"></a>00437     <span class="comment">//.... Check if operation timed out</span>
<a name="l00438"></a>00438     <span class="keywordflow">if</span>(Ok != enResult)
<a name="l00439"></a>00439     {
<a name="l00440"></a>00440       <span class="keywordflow">return</span> Error;
<a name="l00441"></a>00441     }
<a name="l00442"></a>00442 
<a name="l00443"></a>00443     <span class="comment">// Reset callback functions and receive buffer.</span>
<a name="l00444"></a>00444     pstcHsSpiInternData-&gt;<a class="code" href="structstc__hsspi__intern__data.html#a2a33cf5ed480693b0adb053623d67d22">pfnTxStatusCallbackFunction</a> = NULL;
<a name="l00445"></a>00445     pstcHsSpiInternData-&gt;<a class="code" href="structstc__hsspi__intern__data.html#ad058a84e4a88cd35d7ed5f83bc26ce1f">pu8RXBuffer</a> = NULL;
<a name="l00446"></a>00446 
<a name="l00447"></a>00447     <span class="comment">// Reset peripheral communication register (PCC0 .. PCC3).</span>
<a name="l00448"></a>00448     pstcHsSpi-&gt;PCC0_f.SAFESYNC = 1u;
<a name="l00449"></a>00449     pstcHsSpi-&gt;PCC1_f.SAFESYNC = 1u;
<a name="l00450"></a>00450     pstcHsSpi-&gt;PCC2_f.SAFESYNC = 1u;
<a name="l00451"></a>00451     pstcHsSpi-&gt;PCC3_f.SAFESYNC = 1u;
<a name="l00452"></a>00452 
<a name="l00453"></a>00453     <span class="comment">// Disable and clear transmit interrupt.</span>
<a name="l00454"></a>00454     pstcHsSpi-&gt;TXE = 0u;
<a name="l00455"></a>00455     
<a name="l00456"></a>00456     pstcHsSpi-&gt;TXC_f.TSSRC  = 1u;
<a name="l00457"></a>00457     pstcHsSpi-&gt;TXC_f.TFMTC  = 1u;
<a name="l00458"></a>00458     pstcHsSpi-&gt;TXC_f.TFLETC = 1u;
<a name="l00459"></a>00459     pstcHsSpi-&gt;TXC_f.TFUC   = 1u;
<a name="l00460"></a>00460     pstcHsSpi-&gt;TXC_f.TFOC   = 1u;
<a name="l00461"></a>00461     pstcHsSpi-&gt;TXC_f.TFEC   = 1u;
<a name="l00462"></a>00462     pstcHsSpi-&gt;TXC_f.TFFC   = 1u;
<a name="l00463"></a>00463 
<a name="l00464"></a>00464     <span class="comment">// Disable and clear receive interrupt.</span>
<a name="l00465"></a>00465     pstcHsSpi-&gt;RXE = 0u;
<a name="l00466"></a>00466     pstcHsSpi-&gt;RXC_f.RSSRC  = 1u;
<a name="l00467"></a>00467     pstcHsSpi-&gt;RXC_f.RFMTC  = 1u;
<a name="l00468"></a>00468     pstcHsSpi-&gt;RXC_f.RFLETC = 1u;
<a name="l00469"></a>00469     pstcHsSpi-&gt;RXC_f.RFUC   = 1u;
<a name="l00470"></a>00470     pstcHsSpi-&gt;RXC_f.RFOC   = 1u;
<a name="l00471"></a>00471     pstcHsSpi-&gt;RXC_f.RFEC   = 1u;
<a name="l00472"></a>00472     pstcHsSpi-&gt;RXC_f.RFFC   = 1u;
<a name="l00473"></a>00473 
<a name="l00474"></a>00474     <span class="comment">// Clear fault interrupts.</span>
<a name="l00475"></a>00475     pstcHsSpi-&gt;FAULTC_f.DWCBSFC = 1u;
<a name="l00476"></a>00476     pstcHsSpi-&gt;FAULTC_f.DRCBSFC = 1u;
<a name="l00477"></a>00477     pstcHsSpi-&gt;FAULTC_f.PVFC    = 1u;
<a name="l00478"></a>00478     pstcHsSpi-&gt;FAULTC_f.WAFC    = 1u;
<a name="l00479"></a>00479     pstcHsSpi-&gt;FAULTC_f.UMAFC   = 1u;
<a name="l00480"></a>00480 
<a name="l00481"></a>00481     <span class="comment">// Reset direct mode configuration register.</span>
<a name="l00482"></a>00482     pstcHsSpi-&gt;DMCFG = 0u;
<a name="l00483"></a>00483 
<a name="l00484"></a>00484     <span class="comment">// Reset direct mode DMA enable register.</span>
<a name="l00485"></a>00485     pstcHsSpi-&gt;DMDMAEN = 0u;
<a name="l00486"></a>00486 
<a name="l00487"></a>00487     <span class="comment">// Reset direct mode peripheral select register.</span>
<a name="l00488"></a>00488     pstcHsSpi-&gt;DMPSEL = 0u;
<a name="l00489"></a>00489 
<a name="l00490"></a>00490     <span class="comment">// Reset direct mode transfer protocol register.</span>
<a name="l00491"></a>00491     pstcHsSpi-&gt;DMTRP = 0u;
<a name="l00492"></a>00492 
<a name="l00493"></a>00493     <span class="comment">// Reset direct mode byte count control register.</span>
<a name="l00494"></a>00494     pstcHsSpi-&gt;DMBCC = 0u;
<a name="l00495"></a>00495 
<a name="l00496"></a>00496     <span class="comment">// Reset receive FIFO, transmit FIFO, and flush FIFOs.</span>
<a name="l00497"></a>00497     pstcHsSpi-&gt;FIFOCFG_f.TXFLSH = 1u;
<a name="l00498"></a>00498     pstcHsSpi-&gt;FIFOCFG_f.RXFLSH = 1u;
<a name="l00499"></a>00499     pstcHsSpi-&gt;FIFOCFG_f.FWIDTH = 0u;
<a name="l00500"></a>00500     pstcHsSpi-&gt;FIFOCFG_f.TXFTH  = 7u;
<a name="l00501"></a>00501     pstcHsSpi-&gt;FIFOCFG_f.RXFTH  = 7u;
<a name="l00502"></a>00502 
<a name="l00503"></a>00503     <span class="comment">// Reset command sequencer configuration register.</span>
<a name="l00504"></a>00504     pstcHsSpi-&gt;CSCFG = 0u;
<a name="l00505"></a>00505 
<a name="l00506"></a>00506     <span class="comment">// Reset command sequencer idle time register.</span>
<a name="l00507"></a>00507     pstcHsSpi-&gt;CSITIME = 0x0000FFFFul;
<a name="l00508"></a>00508 
<a name="l00509"></a>00509     <span class="comment">// Reset command sequencer address extension register.</span>
<a name="l00510"></a>00510     pstcHsSpi-&gt;CSAEXT_f.AEXT = 0x00u;
<a name="l00511"></a>00511 
<a name="l00512"></a>00512     <span class="comment">// Reset command sequence data/control register.</span>
<a name="l00513"></a>00513     pstcHsSpi-&gt;RDCSDC0 = 0u;
<a name="l00514"></a>00514     pstcHsSpi-&gt;RDCSDC1 = 0u;
<a name="l00515"></a>00515     pstcHsSpi-&gt;RDCSDC2 = 0u;
<a name="l00516"></a>00516     pstcHsSpi-&gt;RDCSDC3 = 0u;
<a name="l00517"></a>00517     pstcHsSpi-&gt;RDCSDC4 = 0u;
<a name="l00518"></a>00518     pstcHsSpi-&gt;RDCSDC5 = 0u;
<a name="l00519"></a>00519     pstcHsSpi-&gt;RDCSDC6 = 0u;
<a name="l00520"></a>00520     pstcHsSpi-&gt;RDCSDC7 = 0u;
<a name="l00521"></a>00521 
<a name="l00522"></a>00522     pstcHsSpi-&gt;WRCSDC0 = 0u;
<a name="l00523"></a>00523     pstcHsSpi-&gt;WRCSDC1 = 0u;
<a name="l00524"></a>00524     pstcHsSpi-&gt;WRCSDC2 = 0u;
<a name="l00525"></a>00525     pstcHsSpi-&gt;WRCSDC3 = 0u;
<a name="l00526"></a>00526     pstcHsSpi-&gt;WRCSDC4 = 0u;
<a name="l00527"></a>00527     pstcHsSpi-&gt;WRCSDC5 = 0u;
<a name="l00528"></a>00528     pstcHsSpi-&gt;WRCSDC6 = 0u;
<a name="l00529"></a>00529     pstcHsSpi-&gt;WRCSDC7 = 0u;
<a name="l00530"></a>00530 
<a name="l00531"></a>00531     <span class="comment">// Reset module control register.</span>
<a name="l00532"></a>00532     pstcHsSpi-&gt;MCTRL = 0u;
<a name="l00533"></a>00533 
<a name="l00534"></a>00534     <span class="keywordflow">return</span> Ok;
<a name="l00535"></a>00535 } <span class="comment">// HsSpi_DeInit</span>
<a name="l00536"></a>00536 
<a name="l00559"></a><a class="code" href="group___hs_spi_group.html#gaba1e150431d43f0f7dc27519c0153f1e">00559</a> en_result_t <a class="code" href="group___hs_spi_group.html#gaba1e150431d43f0f7dc27519c0153f1e" title="Set mode of the HS-SPI unit.">HsSpi_SetMode</a>(<span class="keyword">volatile</span> <a class="code" href="group___hs_spi_group.html#gabf9239d572714b9709b8b01844dfe84f">stc_hsspin_t</a>*        pstcHsSpi,
<a name="l00560"></a>00560                           <a class="code" href="group___hs_spi_group.html#gaa9828ea52aa806d97a11d33168ca7ab4" title="High speed SPI mode.">en_hsspi_mode_t</a>               enMode,
<a name="l00561"></a>00561                           <a class="code" href="group___hs_spi_group.html#ga3cd505b246006cfb968e866f07177263" title="SPI transfer mode (used for Command Sequencer and Direct mode)">en_hsspi_protocol_mode_t</a>      enProtocolMode,
<a name="l00562"></a>00562                           <a class="code" href="group___hs_spi_group.html#ga7aa264a8aeb4bcffec3f0804dc46c995" title="SPI transfer direction.">en_hsspi_protocol_direction_t</a> enProtocolDirection)
<a name="l00563"></a>00563 {
<a name="l00564"></a>00564     <a class="code" href="structstc__hsspi__intern__data.html" title="HS-SPI instance internal data, storing internal information for each enabled HS-SPI instance...">stc_hsspi_intern_data_t</a>* pstcHsSpiInternData;                               <span class="comment">// Pointer to internal data</span>
<a name="l00565"></a>00565     en_result_t enResult;
<a name="l00566"></a>00566     
<a name="l00567"></a>00567     <span class="comment">// Check for NULL-Pointer</span>
<a name="l00568"></a>00568     <span class="keywordflow">if</span> (NULL == pstcHsSpi)
<a name="l00569"></a>00569     {
<a name="l00570"></a>00570         <span class="keywordflow">return</span> ErrorInvalidParameter;
<a name="l00571"></a>00571     }
<a name="l00572"></a>00572 
<a name="l00573"></a>00573     <span class="comment">// Get ptr to internal data struct ...</span>
<a name="l00574"></a>00574     pstcHsSpiInternData = <a class="code" href="group___hs_spi_group.html#ga075c13e0ec20570f5dce624c7daac457" title="Return the internal data for a certain HS-SPI instance.">HsSpiGetInternDataPtr</a>(pstcHsSpi);
<a name="l00575"></a>00575     <span class="comment">// ... and check</span>
<a name="l00576"></a>00576     <span class="keywordflow">if</span> (NULL == pstcHsSpiInternData)
<a name="l00577"></a>00577     {
<a name="l00578"></a>00578         <span class="keywordflow">return</span> ErrorInvalidParameter;
<a name="l00579"></a>00579     }
<a name="l00580"></a>00580 
<a name="l00581"></a>00581     enResult = <a class="code" href="group___hs_spi_group.html#ga14b83b69bca9c376d382ea131ccbc98b" title="Globally disable HS-SPI module by clearing bit MEN.">HsSpi_ModuleDisable</a>(pstcHsSpi);                                  <span class="comment">// Disable before any changes</span>
<a name="l00582"></a>00582     <span class="comment">//.... Check if operation timed out</span>
<a name="l00583"></a>00583     <span class="keywordflow">if</span>(Ok != enResult)
<a name="l00584"></a>00584     {
<a name="l00585"></a>00585       <span class="keywordflow">return</span> Error;
<a name="l00586"></a>00586     }
<a name="l00587"></a>00587     
<a name="l00588"></a>00588     <span class="comment">// Disable transmit complete and transmit FIFO less or equal to threshold interrupt.</span>
<a name="l00589"></a>00589     pstcHsSpi-&gt;TXE_f.TFLETE = 0u;
<a name="l00590"></a>00590     pstcHsSpi-&gt;TXE_f.TFEE   = 0u;
<a name="l00591"></a>00591 
<a name="l00592"></a>00592     <span class="comment">// Reset byte counter.</span>
<a name="l00593"></a>00593     pstcHsSpi-&gt;DMBCC = 0u;
<a name="l00594"></a>00594 
<a name="l00595"></a>00595     <span class="comment">// Flush transmit and receive FIFOs</span>
<a name="l00596"></a>00596     pstcHsSpi-&gt;FIFOCFG_f.TXFLSH = 1u;
<a name="l00597"></a>00597     pstcHsSpi-&gt;FIFOCFG_f.RXFLSH = 1u;
<a name="l00598"></a>00598 
<a name="l00599"></a>00599     <span class="keywordflow">if</span> (enMode == <a class="code" href="group___hs_spi_group.html#ggaf40195d0d8bf3b4d10880323def35ce7ae72d5d8cc570b1c20f429e1c91150241" title="Direct mode is enabled, command sequencer is disabled.">HsSpiModeDirect</a>)
<a name="l00600"></a>00600     {
<a name="l00601"></a>00601         <span class="comment">// Update protocol mode so that transfer functions have access to it</span>
<a name="l00602"></a>00602         pstcHsSpiInternData-&gt;<a class="code" href="structstc__hsspi__intern__data.html#a296445f6fdf4c711614117336229d98b">enDirectModeProtocol</a> = enProtocolMode;
<a name="l00603"></a>00603         <span class="comment">// Just a default (will be setup by the transfer function)</span>
<a name="l00604"></a>00604         
<a name="l00605"></a>00605         <span class="comment">// Set bit mode</span>
<a name="l00606"></a>00606         <span class="keywordflow">switch</span>(enProtocolMode)
<a name="l00607"></a>00607         {
<a name="l00608"></a>00608           <span class="keywordflow">case</span> <a class="code" href="group___hs_spi_group.html#gga68f85282c3247934fd7adad845483c60a468d5e1331e433ffa681e83ca6ef797a" title="Single mode.">HsSpiProtocolModeSingle</a>:
<a name="l00609"></a>00609             pstcHsSpi-&gt;DMTRP = 0x00u;
<a name="l00610"></a>00610             <span class="keywordflow">break</span>;
<a name="l00611"></a>00611           <span class="keywordflow">case</span> <a class="code" href="group___hs_spi_group.html#gga68f85282c3247934fd7adad845483c60ae4cd17ab66650a78813efcaae53d86ed" title="Dual mode, can only be used with the half-duplex functions.">HsSpiProtocolModeDual</a>:
<a name="l00612"></a>00612             pstcHsSpi-&gt;DMTRP = 0x01u;
<a name="l00613"></a>00613             <span class="keywordflow">break</span>;
<a name="l00614"></a>00614           <span class="keywordflow">case</span> <a class="code" href="group___hs_spi_group.html#gga68f85282c3247934fd7adad845483c60a4610cf1f7ef1113c05e9bda6ebd61a2d" title="Quad mode, can only be used with the half-duplex functions.">HsSpiProtocolModeQuad</a>:
<a name="l00615"></a>00615             pstcHsSpi-&gt;DMTRP = 0x02u;
<a name="l00616"></a>00616             <span class="keywordflow">break</span>;
<a name="l00617"></a>00617           <span class="keywordflow">default</span>:
<a name="l00618"></a>00618             <span class="keywordflow">return</span> ErrorInvalidParameter;
<a name="l00619"></a>00619         }
<a name="l00620"></a>00620 
<a name="l00621"></a>00621         <span class="comment">// Set direction mode</span>
<a name="l00622"></a>00622         <span class="keywordflow">switch</span>(enProtocolDirection)
<a name="l00623"></a>00623         {
<a name="l00624"></a>00624           <span class="keywordflow">case</span> <a class="code" href="group___hs_spi_group.html#gga8356027ae41b256fa4fe6acc6e922b18a7e9b233d0f2a03357e74db4f0a9a2dab" title="TX and RX direction.">HsSpiProtocolTxRx</a>:
<a name="l00625"></a>00625             pstcHsSpi-&gt;DMTRP |= 0x00u;
<a name="l00626"></a>00626             <span class="keywordflow">break</span>;
<a name="l00627"></a>00627           <span class="keywordflow">case</span> <a class="code" href="group___hs_spi_group.html#gga8356027ae41b256fa4fe6acc6e922b18a02b3648ab2479da1141203400d301fd5" title="TX direction only.">HsSpiProtocolTx</a>:
<a name="l00628"></a>00628             pstcHsSpi-&gt;DMTRP |= 0x04u;
<a name="l00629"></a>00629             <span class="keywordflow">break</span>;
<a name="l00630"></a>00630           <span class="keywordflow">case</span> <a class="code" href="group___hs_spi_group.html#gga8356027ae41b256fa4fe6acc6e922b18af621aaef713f2e94a1a037851198da27" title="RX direction only.">HsSpiProtocolRx</a>:
<a name="l00631"></a>00631             pstcHsSpi-&gt;DMTRP |= 0x08u;
<a name="l00632"></a>00632             <span class="keywordflow">break</span>;
<a name="l00633"></a>00633           <span class="keywordflow">default</span>:
<a name="l00634"></a>00634             <span class="keywordflow">return</span> ErrorInvalidParameter;
<a name="l00635"></a>00635         }
<a name="l00636"></a>00636         
<a name="l00637"></a>00637         <span class="comment">// Setup new stuff</span>
<a name="l00638"></a>00638         pstcHsSpi-&gt;FIFOCFG_f.RXFTH = 7u;
<a name="l00639"></a>00639         pstcHsSpi-&gt;RXC_f.RFMTC     = 1u;
<a name="l00640"></a>00640 
<a name="l00641"></a>00641         <span class="comment">// Set new mode (direct).</span>
<a name="l00642"></a>00642         pstcHsSpi-&gt;MCTRL_f.CSEN    = 0u;
<a name="l00643"></a>00643     }
<a name="l00644"></a>00644     <span class="keywordflow">else</span>
<a name="l00645"></a>00645     {
<a name="l00646"></a>00646         <span class="comment">// Bit mode</span>
<a name="l00647"></a>00647         <span class="keywordflow">switch</span>(enProtocolMode)
<a name="l00648"></a>00648         {
<a name="l00649"></a>00649           <span class="keywordflow">case</span> <a class="code" href="group___hs_spi_group.html#gga68f85282c3247934fd7adad845483c60a468d5e1331e433ffa681e83ca6ef797a" title="Single mode.">HsSpiProtocolModeSingle</a>:
<a name="l00650"></a>00650             pstcHsSpi-&gt;CSCFG_f.MBM = 0x0u;
<a name="l00651"></a>00651             <span class="keywordflow">break</span>;
<a name="l00652"></a>00652           <span class="keywordflow">case</span> <a class="code" href="group___hs_spi_group.html#gga68f85282c3247934fd7adad845483c60ae4cd17ab66650a78813efcaae53d86ed" title="Dual mode, can only be used with the half-duplex functions.">HsSpiProtocolModeDual</a>:
<a name="l00653"></a>00653             pstcHsSpi-&gt;CSCFG_f.MBM = 0x1u;
<a name="l00654"></a>00654             <span class="keywordflow">break</span>;
<a name="l00655"></a>00655           <span class="keywordflow">case</span> <a class="code" href="group___hs_spi_group.html#gga68f85282c3247934fd7adad845483c60a4610cf1f7ef1113c05e9bda6ebd61a2d" title="Quad mode, can only be used with the half-duplex functions.">HsSpiProtocolModeQuad</a>:
<a name="l00656"></a>00656             pstcHsSpi-&gt;CSCFG_f.MBM = 0x2u;
<a name="l00657"></a>00657             <span class="keywordflow">break</span>;
<a name="l00658"></a>00658           <span class="keywordflow">default</span>:
<a name="l00659"></a>00659             <span class="keywordflow">return</span> ErrorInvalidParameter;
<a name="l00660"></a>00660         }
<a name="l00661"></a>00661         
<a name="l00662"></a>00662         <span class="comment">// Set new mode (command sequencer).</span>
<a name="l00663"></a>00663         pstcHsSpi-&gt;MCTRL_f.CSEN    = 1u;
<a name="l00664"></a>00664     }
<a name="l00665"></a>00665 
<a name="l00666"></a>00666     pstcHsSpi-&gt;MCTRL_f.SYNCON = 0u;           <span class="comment">// AHB synchronizer circuit on</span>
<a name="l00667"></a>00667     
<a name="l00668"></a>00668     enResult = <a class="code" href="group___hs_spi_group.html#gacffe258666aff8b6d4d2d29ddab17253" title="Globally enable SPI module by setting bit MEN.">HsSpi_ModuleEnable</a>(pstcHsSpi);
<a name="l00669"></a>00669     <span class="comment">//.... Check if operation timed out</span>
<a name="l00670"></a>00670     <span class="keywordflow">if</span>(Ok != enResult)
<a name="l00671"></a>00671     {
<a name="l00672"></a>00672       <span class="keywordflow">return</span> Error;
<a name="l00673"></a>00673     }
<a name="l00674"></a>00674     
<a name="l00675"></a>00675     <span class="keywordflow">return</span> Ok;
<a name="l00676"></a>00676 } <span class="comment">// HsSpi_SetMode</span>
<a name="l00677"></a>00677 
<a name="l00703"></a><a class="code" href="group___hs_spi_group.html#ga80db62528e962c0444c98a962aad556a">00703</a> en_result_t <a class="code" href="group___hs_spi_group.html#ga80db62528e962c0444c98a962aad556a" title="Configures the communication parameters of an external device.">HsSpi_SetExternalDeviceConfig</a>(<span class="keyword">volatile</span> <a class="code" href="group___hs_spi_group.html#gabf9239d572714b9709b8b01844dfe84f">stc_hsspin_t</a>* pstcHsSpi, uint8_t u8DeviceNumber, <span class="keyword">const</span> <a class="code" href="structstc__hsspi__ext__device__config.html" title="(High Speed) SPI external device configuration.">stc_hsspi_ext_device_config_t</a>* pstcConfig)
<a name="l00704"></a>00704 {
<a name="l00705"></a>00705     <a class="code" href="structstc__hsspi__intern__data.html" title="HS-SPI instance internal data, storing internal information for each enabled HS-SPI instance...">stc_hsspi_intern_data_t</a>* pstcHsSpiInternData;                      <span class="comment">// Pointer to internal data</span>
<a name="l00706"></a>00706     stc_hsspi_pcc0_field_t* pstcHsSpiPcc;                              <span class="comment">// Pointer to communication configuration register</span>
<a name="l00707"></a>00707     en_result_t enResult;
<a name="l00708"></a>00708     
<a name="l00709"></a>00709     <span class="comment">// Check for NULL-Pointers</span>
<a name="l00710"></a>00710     <span class="keywordflow">if</span> ((NULL == pstcHsSpi) ||
<a name="l00711"></a>00711         (NULL == pstcConfig)
<a name="l00712"></a>00712        )
<a name="l00713"></a>00713     {
<a name="l00714"></a>00714         <span class="keywordflow">return</span> ErrorInvalidParameter;
<a name="l00715"></a>00715     }
<a name="l00716"></a>00716 
<a name="l00717"></a>00717     <span class="comment">// Get ptr to internal data struct ...</span>
<a name="l00718"></a>00718     pstcHsSpiInternData = <a class="code" href="group___hs_spi_group.html#ga075c13e0ec20570f5dce624c7daac457" title="Return the internal data for a certain HS-SPI instance.">HsSpiGetInternDataPtr</a>(pstcHsSpi);
<a name="l00719"></a>00719     <span class="comment">// ... and check</span>
<a name="l00720"></a>00720     <span class="keywordflow">if</span> (NULL == pstcHsSpiInternData)
<a name="l00721"></a>00721     {
<a name="l00722"></a>00722         <span class="keywordflow">return</span> ErrorInvalidParameter;
<a name="l00723"></a>00723     }
<a name="l00724"></a>00724 
<a name="l00725"></a>00725     <span class="comment">// Check for slave number in range</span>
<a name="l00726"></a>00726     <span class="keywordflow">if</span> (u8DeviceNumber &gt; 3u)
<a name="l00727"></a>00727     {
<a name="l00728"></a>00728         <span class="keywordflow">return</span> ErrorInvalidParameter;
<a name="l00729"></a>00729     }
<a name="l00730"></a>00730 
<a name="l00731"></a>00731     enResult = <a class="code" href="group___hs_spi_group.html#ga14b83b69bca9c376d382ea131ccbc98b" title="Globally disable HS-SPI module by clearing bit MEN.">HsSpi_ModuleDisable</a>(pstcHsSpi);
<a name="l00732"></a>00732     <span class="comment">//.... Check if operation timed out</span>
<a name="l00733"></a>00733     <span class="keywordflow">if</span>(Ok != enResult)
<a name="l00734"></a>00734     {
<a name="l00735"></a>00735       <span class="keywordflow">return</span> Error;
<a name="l00736"></a>00736     }
<a name="l00737"></a>00737 
<a name="l00738"></a>00738     <span class="comment">// Update command sequencer configuration register.</span>
<a name="l00739"></a>00739     <span class="keywordflow">switch</span> (u8DeviceNumber)
<a name="l00740"></a>00740     {
<a name="l00741"></a>00741         <span class="keywordflow">case</span> 0u:
<a name="l00742"></a>00742             pstcHsSpiPcc = (stc_hsspi_pcc0_field_t*)&amp;pstcHsSpi-&gt;PCC0;
<a name="l00743"></a>00743             <span class="keywordflow">break</span>;
<a name="l00744"></a>00744         <span class="keywordflow">case</span> 1u:
<a name="l00745"></a>00745             pstcHsSpiPcc = (stc_hsspi_pcc0_field_t*)&amp;pstcHsSpi-&gt;PCC1;
<a name="l00746"></a>00746             <span class="keywordflow">break</span>;
<a name="l00747"></a>00747         <span class="keywordflow">case</span> 2u:
<a name="l00748"></a>00748             pstcHsSpiPcc = (stc_hsspi_pcc0_field_t*)&amp;pstcHsSpi-&gt;PCC2;
<a name="l00749"></a>00749             <span class="keywordflow">break</span>;
<a name="l00750"></a>00750         <span class="keywordflow">case</span> 3u:
<a name="l00751"></a>00751             pstcHsSpiPcc = (stc_hsspi_pcc0_field_t*)&amp;pstcHsSpi-&gt;PCC3;
<a name="l00752"></a>00752             <span class="keywordflow">break</span>;
<a name="l00753"></a>00753         <span class="keywordflow">default</span>: <span class="comment">// Should never see the daylight</span>
<a name="l00754"></a>00754             <span class="keywordflow">return</span> ErrorInvalidParameter;
<a name="l00755"></a>00755     } <span class="comment">// switch (u8DeviceNumber)</span>
<a name="l00756"></a>00756 
<a name="l00757"></a>00757     <span class="comment">// Update command sequencer configuration register.</span>
<a name="l00758"></a>00758     <span class="keywordflow">switch</span> (u8DeviceNumber)
<a name="l00759"></a>00759     {
<a name="l00760"></a>00760         <span class="keywordflow">case</span> 0u:
<a name="l00761"></a>00761             pstcHsSpi-&gt;CSCFG_f.SSEL0EN = 1u;
<a name="l00762"></a>00762             <span class="keywordflow">break</span>;
<a name="l00763"></a>00763         <span class="keywordflow">case</span> 1u:
<a name="l00764"></a>00764             pstcHsSpi-&gt;CSCFG_f.SSEL1EN = 1u;
<a name="l00765"></a>00765             <span class="keywordflow">break</span>;
<a name="l00766"></a>00766         <span class="keywordflow">case</span> 2u:
<a name="l00767"></a>00767             pstcHsSpi-&gt;CSCFG_f.SSEL2EN = 1u;
<a name="l00768"></a>00768             <span class="keywordflow">break</span>;
<a name="l00769"></a>00769         <span class="keywordflow">case</span> 3u:
<a name="l00770"></a>00770             pstcHsSpi-&gt;CSCFG_f.SSEL3EN = 1u;
<a name="l00771"></a>00771             <span class="keywordflow">break</span>;
<a name="l00772"></a>00772         <span class="keywordflow">default</span>: <span class="comment">// Should never see the daylight</span>
<a name="l00773"></a>00773             <span class="keywordflow">return</span> ErrorInvalidParameter;
<a name="l00774"></a>00774     } <span class="comment">// switch (u8DeviceNumber)</span>
<a name="l00775"></a>00775     
<a name="l00776"></a>00776     <span class="comment">// Backup for later checks</span>
<a name="l00777"></a>00777     pstcHsSpiInternData-&gt;<a class="code" href="structstc__hsspi__intern__data.html#a968f58d177eb296521bbcc6bbcf9b6b6">enClkMode</a> = pstcConfig-&gt;<a class="code" href="structstc__hsspi__ext__device__config.html#a274c1c5ffa6350f42f0ef3b9893482b6" title="See description of en_hsspi_clk_mode_t.">enClockMode</a>;
<a name="l00778"></a>00778 
<a name="l00779"></a>00779     <span class="comment">// Set peripheral communication register (PCC0 .. PCC3).</span>
<a name="l00780"></a>00780     pstcHsSpiPcc-&gt;SAFESYNC = (TRUE == pstcConfig-&gt;<a class="code" href="structstc__hsspi__ext__device__config.html#a80f9e8d719163a6ccaebfb3a105bb0fd" title="SAFESYNC bit set or not.">bSafeSync</a>) ? 1u : 0u;
<a name="l00781"></a>00781     pstcHsSpiPcc-&gt;CDRS     = pstcConfig-&gt;<a class="code" href="structstc__hsspi__ext__device__config.html#a6adb45014eccd4979ee3cccfce443fb6" title="See description of en_hsspi_clk_divider_t.">enClockDivider</a>;
<a name="l00782"></a>00782     pstcHsSpiPcc-&gt;SDIR     = (FALSE == pstcConfig-&gt;<a class="code" href="structstc__hsspi__ext__device__config.html#a0b4f0259f336540f4f6d817e18f76c16" title="TRUE: Least significant bit is transmitted first, FALSE: most significant bit is transmitted first...">bShiftLsbFirst</a>) ? 0u : 1u;
<a name="l00783"></a>00783     pstcHsSpiPcc-&gt;SS2CD    = pstcConfig-&gt;<a class="code" href="structstc__hsspi__ext__device__config.html#af2466fb8f887febe8614ed300cd81c7f" title="See description of en_hsspi_clk_delay_t.">enClockDelay</a>;
<a name="l00784"></a>00784     pstcHsSpiPcc-&gt;SSPOL    = (FALSE == pstcConfig-&gt;<a class="code" href="structstc__hsspi__ext__device__config.html#aa308cd1380679e69c10169f56ad743e2" title="FALSE: Slave select is low-active and held during default state, TRUE: Slave select is high-active an...">bSlaveSelectPolarityHigh</a>) ? 0u : 1u;
<a name="l00785"></a>00785     pstcHsSpiPcc-&gt;RTM      = (TRUE == pstcConfig-&gt;<a class="code" href="structstc__hsspi__ext__device__config.html#aeda76d8fccce2df8bac1312ad8aeca2c" title="TRUE: reception by time-compensated clock, FALSE: No time-compensation.">bCompensatedClock</a>) ? 1u : 0u;
<a name="l00786"></a>00786     pstcHsSpiPcc-&gt;ACES     = ((pstcConfig-&gt;<a class="code" href="structstc__hsspi__ext__device__config.html#a274c1c5ffa6350f42f0ef3b9893482b6" title="See description of en_hsspi_clk_mode_t.">enClockMode</a> &gt;&gt; 2u) &amp; 0x01u);
<a name="l00787"></a>00787     pstcHsSpiPcc-&gt;CPOL     = ((pstcConfig-&gt;<a class="code" href="structstc__hsspi__ext__device__config.html#a274c1c5ffa6350f42f0ef3b9893482b6" title="See description of en_hsspi_clk_mode_t.">enClockMode</a> &gt;&gt; 1u) &amp; 0x01u);
<a name="l00788"></a>00788     pstcHsSpiPcc-&gt;CPHA     = (pstcConfig-&gt;<a class="code" href="structstc__hsspi__ext__device__config.html#a274c1c5ffa6350f42f0ef3b9893482b6" title="See description of en_hsspi_clk_mode_t.">enClockMode</a> &amp; 0x0u);
<a name="l00789"></a>00789     
<a name="l00790"></a>00790     <span class="comment">// Set endianess</span>
<a name="l00791"></a>00791     <span class="keywordflow">switch</span>(pstcConfig-&gt;<a class="code" href="structstc__hsspi__ext__device__config.html#a18b7cdebdf5d31e02a8fcc285333e141" title="Endianess, see en_hsspi_endianess_t for details.">enEndianess</a>)
<a name="l00792"></a>00792     {
<a name="l00793"></a>00793       <span class="keywordflow">case</span> <a class="code" href="group___hs_spi_group.html#ggad1d1746588560eb24dca4d2f86e4692da5402158c81863705cd6da23a03efbdfe" title="Big Endian.">HsSpiBigEndian</a>:
<a name="l00794"></a>00794         pstcHsSpiPcc-&gt;SENDIAN = 0u;
<a name="l00795"></a>00795         <span class="keywordflow">break</span>;
<a name="l00796"></a>00796       <span class="keywordflow">case</span> <a class="code" href="group___hs_spi_group.html#ggad1d1746588560eb24dca4d2f86e4692da839551943135041d1845e818afa71950" title="Little Endian.">HsSpiLittleEndian</a>:
<a name="l00797"></a>00797         pstcHsSpiPcc-&gt;SENDIAN = 1u;
<a name="l00798"></a>00798         <span class="keywordflow">break</span>;
<a name="l00799"></a>00799       <span class="keywordflow">default</span>:
<a name="l00800"></a>00800         <span class="keywordflow">return</span> ErrorInvalidParameter;
<a name="l00801"></a>00801     }
<a name="l00802"></a>00802 
<a name="l00803"></a>00803     <span class="comment">// Set read deselect time</span>
<a name="l00804"></a>00804     <span class="keywordflow">if</span> ((pstcConfig-&gt;<a class="code" href="structstc__hsspi__ext__device__config.html#aed53a5bc54019d56726483112496c913" title="Read Deselect Time. Allowed values: 1 ... 4 serial clock times.">u8ReadDeselectTime</a> &lt; 1u) || (pstcConfig-&gt;<a class="code" href="structstc__hsspi__ext__device__config.html#aed53a5bc54019d56726483112496c913" title="Read Deselect Time. Allowed values: 1 ... 4 serial clock times.">u8ReadDeselectTime</a> &gt; 4u))
<a name="l00805"></a>00805     {
<a name="l00806"></a>00806       <span class="keywordflow">return</span> ErrorInvalidParameter;
<a name="l00807"></a>00807     }
<a name="l00808"></a>00808     pstcHsSpiPcc-&gt;RDDSEL = pstcConfig-&gt;<a class="code" href="structstc__hsspi__ext__device__config.html#aed53a5bc54019d56726483112496c913" title="Read Deselect Time. Allowed values: 1 ... 4 serial clock times.">u8ReadDeselectTime</a>  - 1u;
<a name="l00809"></a>00809     
<a name="l00810"></a>00810     <span class="comment">// Set write/different command deselect time</span>
<a name="l00811"></a>00811     <span class="keywordflow">if</span> ((pstcConfig-&gt;<a class="code" href="structstc__hsspi__ext__device__config.html#a00f19f352e312ebdece23800f94a75fa" title="Write/different Command Deselect Time. Allowed values: 1 ... 16 serial clock times.">u8WriteDeselectTime</a> &lt; 1u) || (pstcConfig-&gt;<a class="code" href="structstc__hsspi__ext__device__config.html#a00f19f352e312ebdece23800f94a75fa" title="Write/different Command Deselect Time. Allowed values: 1 ... 16 serial clock times.">u8WriteDeselectTime</a> &gt; 16u))
<a name="l00812"></a>00812     {
<a name="l00813"></a>00813       <span class="keywordflow">return</span> ErrorInvalidParameter;
<a name="l00814"></a>00814     }
<a name="l00815"></a>00815     pstcHsSpiPcc-&gt;WRDSEL = pstcConfig-&gt;<a class="code" href="structstc__hsspi__ext__device__config.html#a00f19f352e312ebdece23800f94a75fa" title="Write/different Command Deselect Time. Allowed values: 1 ... 16 serial clock times.">u8WriteDeselectTime</a>  - 1u;
<a name="l00816"></a>00816     
<a name="l00817"></a>00817     enResult = <a class="code" href="group___hs_spi_group.html#gacffe258666aff8b6d4d2d29ddab17253" title="Globally enable SPI module by setting bit MEN.">HsSpi_ModuleEnable</a>(pstcHsSpi);
<a name="l00818"></a>00818     <span class="comment">//.... Check if operation timed out</span>
<a name="l00819"></a>00819     <span class="keywordflow">if</span>(Ok != enResult)
<a name="l00820"></a>00820     {
<a name="l00821"></a>00821       <span class="keywordflow">return</span> Error;
<a name="l00822"></a>00822     }
<a name="l00823"></a>00823 
<a name="l00824"></a>00824     <span class="keywordflow">return</span> Ok;
<a name="l00825"></a>00825 } <span class="comment">// HsSpi_SetExternalDeviceConfig</span>
<a name="l00826"></a>00826 
<a name="l00866"></a><a class="code" href="group___hs_spi_group.html#ga3c4d4f5d720b75472f88ddf2defe996b">00866</a> en_result_t <a class="code" href="group___hs_spi_group.html#ga3c4d4f5d720b75472f88ddf2defe996b" title="Transfers data in direct half-duplex mode.">HsSpi_DirectModeTransferHalfDuplex</a>(<span class="keyword">volatile</span> <a class="code" href="group___hs_spi_group.html#gabf9239d572714b9709b8b01844dfe84f">stc_hsspin_t</a>* pstcHsSpi, uint8_t u8DeviceNumber, <span class="keyword">const</span> uint8_t* pu8TxData, uint16_t u16TxSize, uint8_t* pu8RxData, uint16_t u16RxSize, boolean_t bEnableTxDmaRequest)
<a name="l00867"></a>00867 {
<a name="l00868"></a>00868     <a class="code" href="structstc__hsspi__linked__data__list.html" title="(High Speed) SPI linked data list.">stc_hsspi_linked_data_list_t</a> stcDataList;
<a name="l00869"></a>00869     
<a name="l00870"></a>00870     stcDataList.<a class="code" href="structstc__hsspi__linked__data__list.html#aa4eeb6195b9e018b98794d385d89ef94" title="Pointer to transfer data.">pu8Data</a>             = pu8TxData;
<a name="l00871"></a>00871     stcDataList.<a class="code" href="structstc__hsspi__linked__data__list.html#a9757456bb93891109ed071793bb02761" title="Size of transfer data.">u16ListItemDataSize</a> = u16TxSize;
<a name="l00872"></a>00872     stcDataList.<a class="code" href="structstc__hsspi__linked__data__list.html#a79b0ff0a9c1602860c6df64db2215481" title="Pointer to next stc_hsspi_linked_data_list_t item or NULL if end of list.">pstcNext</a>            = 0ul;
<a name="l00873"></a>00873     
<a name="l00874"></a>00874     <span class="keywordflow">return</span> <a class="code" href="group___hs_spi_group.html#gaabd3e2de597791f8a5ae640088da7df6" title="Transfers linked data in direct half-duplex mode.">HsSpi_DirectModeTransferHalfDuplexList</a>(pstcHsSpi, u8DeviceNumber, &amp;stcDataList, pu8RxData, u16RxSize, bEnableTxDmaRequest);
<a name="l00875"></a>00875 }
<a name="l00876"></a>00876 
<a name="l00917"></a><a class="code" href="group___hs_spi_group.html#gaabd3e2de597791f8a5ae640088da7df6">00917</a> <span class="keyword">extern</span> en_result_t <a class="code" href="group___hs_spi_group.html#gaabd3e2de597791f8a5ae640088da7df6" title="Transfers linked data in direct half-duplex mode.">HsSpi_DirectModeTransferHalfDuplexList</a>(<span class="keyword">volatile</span> <a class="code" href="group___hs_spi_group.html#gabf9239d572714b9709b8b01844dfe84f">stc_hsspin_t</a>* pstcHsSpi, uint8_t u8DeviceNumber, <span class="keyword">const</span> <a class="code" href="structstc__hsspi__linked__data__list.html" title="(High Speed) SPI linked data list.">stc_hsspi_linked_data_list_t</a>* pstcTxData, uint8_t* pu8RxData, uint16_t u16RxSize, boolean_t bEnableTxDmaRequest)
<a name="l00918"></a>00918 {
<a name="l00919"></a>00919     <a class="code" href="structstc__hsspi__intern__data.html" title="HS-SPI instance internal data, storing internal information for each enabled HS-SPI instance...">stc_hsspi_intern_data_t</a>* pstcHsSpiInternData;
<a name="l00920"></a>00920     <span class="keyword">const</span> <a class="code" href="structstc__hsspi__linked__data__list.html" title="(High Speed) SPI linked data list.">stc_hsspi_linked_data_list_t</a>* pstcListItem;
<a name="l00921"></a>00921     uint8_t  u8TrpBackup;
<a name="l00922"></a>00922     uint8_t  u8Index;
<a name="l00923"></a>00923     uint8_t  u8LoopEndIndex;
<a name="l00924"></a>00924     uint16_t u16TransmissionLength;
<a name="l00925"></a>00925     uint16_t u16TxSize = 0u;
<a name="l00926"></a>00926     uint16_t u16RxDataCount = 0u;
<a name="l00927"></a>00927     uint16_t u16TxDataCount = 0u;
<a name="l00928"></a>00928     uint16_t u16ListItemDataCount = 0u;
<a name="l00929"></a>00929     <span class="keyword">volatile</span> uint8_t u8DummyRead;
<a name="l00930"></a>00930     en_result_t enResult;
<a name="l00931"></a>00931     
<a name="l00932"></a>00932     <span class="comment">// Check for NULL-Pointer</span>
<a name="l00933"></a>00933     <span class="keywordflow">if</span> ((NULL == pstcHsSpi) ||
<a name="l00934"></a>00934         (NULL == pstcTxData) ||
<a name="l00935"></a>00935         (NULL == pstcTxData-&gt;<a class="code" href="structstc__hsspi__linked__data__list.html#aa4eeb6195b9e018b98794d385d89ef94" title="Pointer to transfer data.">pu8Data</a>) ||
<a name="l00936"></a>00936         (TRUE == bEnableTxDmaRequest)               <span class="comment">// Currently not supported</span>
<a name="l00937"></a>00937        )
<a name="l00938"></a>00938     {
<a name="l00939"></a>00939         <span class="keywordflow">return</span> ErrorInvalidParameter;
<a name="l00940"></a>00940     }
<a name="l00941"></a>00941 
<a name="l00942"></a>00942     <span class="comment">// Get ptr to internal data struct ...</span>
<a name="l00943"></a>00943     pstcHsSpiInternData = <a class="code" href="group___hs_spi_group.html#ga075c13e0ec20570f5dce624c7daac457" title="Return the internal data for a certain HS-SPI instance.">HsSpiGetInternDataPtr</a>(pstcHsSpi);
<a name="l00944"></a>00944     <span class="comment">// ... and check</span>
<a name="l00945"></a>00945     <span class="keywordflow">if</span> (NULL == pstcHsSpiInternData)
<a name="l00946"></a>00946     {
<a name="l00947"></a>00947         <span class="keywordflow">return</span> ErrorInvalidParameter;
<a name="l00948"></a>00948     }
<a name="l00949"></a>00949 
<a name="l00950"></a>00950     <span class="comment">// Check for slave number in range</span>
<a name="l00951"></a>00951     <span class="keywordflow">if</span> (u8DeviceNumber &gt; 3u)
<a name="l00952"></a>00952     {
<a name="l00953"></a>00953         <span class="keywordflow">return</span> ErrorInvalidParameter;
<a name="l00954"></a>00954     }
<a name="l00955"></a>00955     
<a name="l00956"></a>00956     <span class="comment">// Iterate through linked list to sum up total TX size</span>
<a name="l00957"></a>00957     pstcListItem = pstcTxData;
<a name="l00958"></a>00958     <span class="keywordflow">do</span>
<a name="l00959"></a>00959     {
<a name="l00960"></a>00960         u16TxSize += pstcListItem-&gt;<a class="code" href="structstc__hsspi__linked__data__list.html#a9757456bb93891109ed071793bb02761" title="Size of transfer data.">u16ListItemDataSize</a>;
<a name="l00961"></a>00961         pstcListItem = pstcListItem-&gt;<a class="code" href="structstc__hsspi__linked__data__list.html#a79b0ff0a9c1602860c6df64db2215481" title="Pointer to next stc_hsspi_linked_data_list_t item or NULL if end of list.">pstcNext</a>;
<a name="l00962"></a>00962     } <span class="keywordflow">while</span>((uint32_t)pstcListItem != 0ul);  
<a name="l00963"></a>00963 
<a name="l00964"></a>00964     <span class="comment">// Check for valid transfer size</span>
<a name="l00965"></a>00965     <span class="keywordflow">if</span> (0u == u16TxSize)
<a name="l00966"></a>00966     {
<a name="l00967"></a>00967         <span class="keywordflow">return</span> ErrorInvalidParameter;
<a name="l00968"></a>00968     }
<a name="l00969"></a>00969     
<a name="l00970"></a>00970     <span class="comment">// Check for valid total transmission size</span>
<a name="l00971"></a>00971     <span class="keywordflow">if</span> (((uint32_t) u16TxSize + (uint32_t) u16RxSize) &gt; 65535u)
<a name="l00972"></a>00972     {
<a name="l00973"></a>00973         <span class="keywordflow">return</span> ErrorInvalidParameter;
<a name="l00974"></a>00974     }
<a name="l00975"></a>00975 
<a name="l00976"></a>00976     <span class="comment">// Check if there is a pending transmission</span>
<a name="l00977"></a>00977     <span class="keywordflow">if</span> (pstcHsSpi-&gt;DMSTATUS_f.TXACTIVE != 0u)
<a name="l00978"></a>00978     {
<a name="l00979"></a>00979         <span class="keywordflow">return</span> ErrorOperationInProgress;
<a name="l00980"></a>00980     }
<a name="l00981"></a>00981 
<a name="l00982"></a>00982     <span class="comment">// Check if we&#39;re in direct mode.</span>
<a name="l00983"></a>00983     <span class="keywordflow">if</span> (pstcHsSpi-&gt;MCTRL_f.CSEN != 0u)
<a name="l00984"></a>00984     {
<a name="l00985"></a>00985         <span class="keywordflow">return</span> ErrorInvalidMode;
<a name="l00986"></a>00986     }
<a name="l00987"></a>00987 
<a name="l00988"></a>00988     <span class="comment">// Check for SPI modes which may be used in faked half-duplex mode</span>
<a name="l00989"></a>00989     <span class="keywordflow">if</span> ((pstcHsSpiInternData-&gt;<a class="code" href="structstc__hsspi__intern__data.html#a968f58d177eb296521bbcc6bbcf9b6b6">enClkMode</a>) &gt;= <a class="code" href="group___hs_spi_group.html#gga52d2086b160266357f91b0cbdaf46a09a80b3fc8e21408985c393b75f17b8424a" title="Serial clock low during idle, data output set with falling clock edge, data input sampling with falli...">HsSpiClkLowOutFallingInFalling</a>)
<a name="l00990"></a>00990     {
<a name="l00991"></a>00991         <span class="comment">// Modes &gt;= SPI Mode 4 are not supported in full duplex mode (see hardware manual) which is</span>
<a name="l00992"></a>00992         <span class="comment">// used for faking half duplex mode. Legacy mode must be used too, because switching from</span>
<a name="l00993"></a>00993         <span class="comment">// TX-only to RX-only inside a transmission is not recommended (see hardware manual)</span>
<a name="l00994"></a>00994         <span class="keywordflow">return</span> ErrorInvalidMode;
<a name="l00995"></a>00995     }
<a name="l00996"></a>00996 
<a name="l00997"></a>00997     <span class="comment">// Store receive buffer pointer</span>
<a name="l00998"></a>00998     pstcHsSpiInternData-&gt;<a class="code" href="structstc__hsspi__intern__data.html#ad058a84e4a88cd35d7ed5f83bc26ce1f">pu8RXBuffer</a> = pu8RxData;
<a name="l00999"></a>00999 
<a name="l01000"></a>01000     <span class="comment">// Select current device for transmission.</span>
<a name="l01001"></a>01001     pstcHsSpi-&gt;DMPSEL = u8DeviceNumber;
<a name="l01002"></a>01002 
<a name="l01003"></a>01003     <span class="comment">// Backup current protocol mode</span>
<a name="l01004"></a>01004     u8TrpBackup = pstcHsSpi-&gt;DMTRP;
<a name="l01005"></a>01005 
<a name="l01006"></a>01006     enResult = <a class="code" href="group___hs_spi_group.html#ga14b83b69bca9c376d382ea131ccbc98b" title="Globally disable HS-SPI module by clearing bit MEN.">HsSpi_ModuleDisable</a>(pstcHsSpi);
<a name="l01007"></a>01007     <span class="comment">//.... Check if operation timed out</span>
<a name="l01008"></a>01008     <span class="keywordflow">if</span>(Ok != enResult)
<a name="l01009"></a>01009     {
<a name="l01010"></a>01010       <span class="keywordflow">return</span> Error;
<a name="l01011"></a>01011     }
<a name="l01012"></a>01012     
<a name="l01013"></a>01013     <span class="comment">// We are faking a half duplex mode for the upper layer by ignoring and not storing the unwanted data.</span>
<a name="l01014"></a>01014     <span class="comment">// Setting to SpiDirectModeTxRxLegacyMode</span>
<a name="l01015"></a>01015     pstcHsSpi-&gt;DMTRP = <a class="code" href="group___hs_spi_group.html#ga4270126336e68b080d629031d01d2fa9" title="HS-SPI transfer mode (hardware).">HSSPI_DIRECT_MODE_TX_RX_SINGLE_MODE</a>;
<a name="l01016"></a>01016     
<a name="l01017"></a>01017     enResult = <a class="code" href="group___hs_spi_group.html#gacffe258666aff8b6d4d2d29ddab17253" title="Globally enable SPI module by setting bit MEN.">HsSpi_ModuleEnable</a>(pstcHsSpi);
<a name="l01018"></a>01018     <span class="comment">//.... Check if operation timed out</span>
<a name="l01019"></a>01019     <span class="keywordflow">if</span>(Ok != enResult)
<a name="l01020"></a>01020     {
<a name="l01021"></a>01021       <span class="keywordflow">return</span> Error;
<a name="l01022"></a>01022     }
<a name="l01023"></a>01023     
<a name="l01024"></a>01024     <span class="comment">// Flush transmit and receive FIFOs</span>
<a name="l01025"></a>01025     pstcHsSpi-&gt;FIFOCFG_f.TXFLSH = 1u;
<a name="l01026"></a>01026     pstcHsSpi-&gt;FIFOCFG_f.RXFLSH = 1u;
<a name="l01027"></a>01027 
<a name="l01028"></a>01028     <span class="comment">// In half-duplex mode the number of bytes in this transaction is the sum of TX and RX</span>
<a name="l01029"></a>01029     u16TransmissionLength = u16TxSize + u16RxSize;
<a name="l01030"></a>01030     pstcHsSpi-&gt;DMBCC = u16TransmissionLength;
<a name="l01031"></a>01031     
<a name="l01032"></a>01032     <span class="comment">// Preset current list item with the first list item</span>
<a name="l01033"></a>01033     pstcListItem = pstcTxData;
<a name="l01034"></a>01034 
<a name="l01035"></a>01035     <span class="comment">// Trigger start of transfer.</span>
<a name="l01036"></a>01036     pstcHsSpi-&gt;DMSTART_f.START = 1u;    
<a name="l01037"></a>01037     
<a name="l01038"></a>01038     <span class="comment">// Loop until whole transmission has finished</span>
<a name="l01039"></a>01039     <span class="keywordflow">while</span>(u16TxDataCount &lt; u16TransmissionLength)
<a name="l01040"></a>01040     {   
<a name="l01041"></a>01041         <span class="comment">// Put max FIFO size or remaining bytes of transmission (whichever is less) in TX FIFO</span>
<a name="l01042"></a>01042         u8LoopEndIndex = MIN(<a class="code" href="group___hs_spi_group.html#gab176ed4b683a2e6e88ea789352119f44" title="Transmit and receive maximum FIFO depth.">HS_SPI_MAX_FIFO_DEPTH</a>, (u16TransmissionLength - u16TxDataCount));
<a name="l01043"></a>01043         <span class="keywordflow">for</span> (u8Index = 0u; u8Index &lt; u8LoopEndIndex; u8Index++)
<a name="l01044"></a>01044         {  
<a name="l01045"></a>01045             <span class="comment">// Put actual transmit data in FIFO or just dummy data for second part (=receive part) of half duplex transaction</span>
<a name="l01046"></a>01046             *((uint8_t*)&amp;pstcHsSpi-&gt;TXFIFO0) = (u16TxDataCount &lt; u16TxSize) ? (uint8_t)pstcListItem-&gt;<a class="code" href="structstc__hsspi__linked__data__list.html#aa4eeb6195b9e018b98794d385d89ef94" title="Pointer to transfer data.">pu8Data</a>[u16ListItemDataCount] : 0u;
<a name="l01047"></a>01047             
<a name="l01048"></a>01048             u16TxDataCount++;
<a name="l01049"></a>01049             <span class="comment">// Pointer will be 0 when RX phase has been reached</span>
<a name="l01050"></a>01050             <span class="keywordflow">if</span>((uint32_t)pstcListItem != 0ul)
<a name="l01051"></a>01051             {
<a name="l01052"></a>01052                 u16ListItemDataCount++;
<a name="l01053"></a>01053                 <span class="comment">// Set next list item (or 0) as new current list item when</span>
<a name="l01054"></a>01054                 <span class="comment">// all data of the current list item has been transmitted</span>
<a name="l01055"></a>01055                 <span class="keywordflow">if</span>(u16ListItemDataCount &gt;= pstcListItem-&gt;<a class="code" href="structstc__hsspi__linked__data__list.html#a9757456bb93891109ed071793bb02761" title="Size of transfer data.">u16ListItemDataSize</a>)
<a name="l01056"></a>01056                 {
<a name="l01057"></a>01057                     pstcListItem = pstcListItem-&gt;<a class="code" href="structstc__hsspi__linked__data__list.html#a79b0ff0a9c1602860c6df64db2215481" title="Pointer to next stc_hsspi_linked_data_list_t item or NULL if end of list.">pstcNext</a>;
<a name="l01058"></a>01058                     u16ListItemDataCount = 0u;                
<a name="l01059"></a>01059                 }  
<a name="l01060"></a>01060             }      
<a name="l01061"></a>01061         }
<a name="l01062"></a>01062         
<a name="l01063"></a>01063         <span class="comment">// Clear &quot;transmit FIFO &amp; shift register&quot; empty flag.</span>
<a name="l01064"></a>01064         pstcHsSpi-&gt;TXC_f.TFEC = 1u;
<a name="l01065"></a>01065 
<a name="l01066"></a>01066         <span class="comment">// Wait until transfer is finished (no more data in FIFO and shift register empty)</span>
<a name="l01067"></a>01067         <span class="keywordflow">while</span> ((pstcHsSpi-&gt;DMSTATUS_f.TXFLEVEL &gt; 0u) ||
<a name="l01068"></a>01068                (pstcHsSpi-&gt;TXF_f.TFES == 0u)
<a name="l01069"></a>01069               )
<a name="l01070"></a>01070         {
<a name="l01071"></a>01071             <a class="code" href="group___p_d_l.html#ga76336ac37d977e02bf0fdbf84b1e3fd1" title="Hook function, which is called in polling loops.">PDL_WAIT_LOOP_HOOK</a>();
<a name="l01072"></a>01072         }
<a name="l01073"></a>01073 
<a name="l01074"></a>01074         <span class="comment">// At the end of transaction (indicated by DMBCS) waiting here is necessary to ensure</span>
<a name="l01075"></a>01075         <span class="comment">// that the last item has been pushed from the shift register to the FIFO (especially at slow SPI clock)</span>
<a name="l01076"></a>01076         <span class="keywordflow">if</span>(0u == pstcHsSpi-&gt;DMBCS)
<a name="l01077"></a>01077         {
<a name="l01078"></a>01078             <span class="keywordflow">while</span> (1u == pstcHsSpi-&gt;DMSTATUS_f.RXACTIVE)
<a name="l01079"></a>01079             {
<a name="l01080"></a>01080                 <a class="code" href="group___p_d_l.html#ga76336ac37d977e02bf0fdbf84b1e3fd1" title="Hook function, which is called in polling loops.">PDL_WAIT_LOOP_HOOK</a>() ;
<a name="l01081"></a>01081             }
<a name="l01082"></a>01082         }
<a name="l01083"></a>01083         
<a name="l01084"></a>01084         <span class="comment">// Check if receive data has been requested</span>
<a name="l01085"></a>01085         <span class="keywordflow">if</span> ((pu8RxData != NULL) &amp;&amp; (u16RxSize &gt; 0u))
<a name="l01086"></a>01086         {
<a name="l01087"></a>01087             <span class="comment">// Data from FIFO is stored in user buffer if RX phase has been reached</span>
<a name="l01088"></a>01088             <span class="keywordflow">while</span> (pstcHsSpi-&gt;DMSTATUS_f.RXFLEVEL &gt; 0u)
<a name="l01089"></a>01089             {
<a name="l01090"></a>01090                 <span class="keywordflow">if</span>(u16RxDataCount &gt;= u16TxSize)
<a name="l01091"></a>01091                 {
<a name="l01092"></a>01092                   pu8RxData[u16RxDataCount - u16TxSize] = *((uint8_t*)&amp;pstcHsSpi-&gt;RXFIFO0);
<a name="l01093"></a>01093                 }
<a name="l01094"></a>01094                 <span class="keywordflow">else</span>
<a name="l01095"></a>01095                 {
<a name="l01096"></a>01096                     u8DummyRead = *((uint8_t*)&amp;pstcHsSpi-&gt;RXFIFO0);      <span class="comment">// &quot;dummy read&quot; to empty FIFO</span>
<a name="l01097"></a>01097                 }
<a name="l01098"></a>01098                 u16RxDataCount++;
<a name="l01099"></a>01099             }
<a name="l01100"></a>01100         }
<a name="l01101"></a>01101         <span class="keywordflow">else</span>
<a name="l01102"></a>01102         {
<a name="l01103"></a>01103             <span class="comment">// Flush receive FIFO in case no receive data has been requested</span>
<a name="l01104"></a>01104             pstcHsSpi-&gt;FIFOCFG_f.RXFLSH = 1u;
<a name="l01105"></a>01105         }
<a name="l01106"></a>01106     }
<a name="l01107"></a>01107 
<a name="l01108"></a>01108     enResult = <a class="code" href="group___hs_spi_group.html#ga14b83b69bca9c376d382ea131ccbc98b" title="Globally disable HS-SPI module by clearing bit MEN.">HsSpi_ModuleDisable</a>(pstcHsSpi);
<a name="l01109"></a>01109     <span class="comment">//.... Check if operation timed out</span>
<a name="l01110"></a>01110     <span class="keywordflow">if</span>(Ok != enResult)
<a name="l01111"></a>01111     {
<a name="l01112"></a>01112       <span class="keywordflow">return</span> Error;
<a name="l01113"></a>01113     }
<a name="l01114"></a>01114     
<a name="l01115"></a>01115     <span class="comment">// Restore protocol mode</span>
<a name="l01116"></a>01116     pstcHsSpi-&gt;DMTRP = u8TrpBackup;
<a name="l01117"></a>01117 
<a name="l01118"></a>01118     enResult = <a class="code" href="group___hs_spi_group.html#gacffe258666aff8b6d4d2d29ddab17253" title="Globally enable SPI module by setting bit MEN.">HsSpi_ModuleEnable</a>(pstcHsSpi);
<a name="l01119"></a>01119     <span class="comment">//.... Check if operation timed out</span>
<a name="l01120"></a>01120     <span class="keywordflow">if</span>(Ok != enResult)
<a name="l01121"></a>01121     {
<a name="l01122"></a>01122       <span class="keywordflow">return</span> Error;
<a name="l01123"></a>01123     }
<a name="l01124"></a>01124     
<a name="l01125"></a>01125     <span class="keywordflow">return</span> Ok;
<a name="l01126"></a>01126 } <span class="comment">// HsSpi_DirectModeTransferHalfDuplexList</span>
<a name="l01127"></a>01127 
<a name="l01151"></a><a class="code" href="group___hs_spi_group.html#gab712aeb658f9f6917d13dd91049f4510">01151</a> en_result_t <a class="code" href="group___hs_spi_group.html#gab712aeb658f9f6917d13dd91049f4510" title="Set read command sequence for command sequencer mode.">HsSpi_SetReadCommandSequence</a>(<span class="keyword">volatile</span> <a class="code" href="group___hs_spi_group.html#gabf9239d572714b9709b8b01844dfe84f">stc_hsspin_t</a>* pstcHsSpi, <span class="keyword">const</span> <a class="code" href="structstc__hsspi__command__sequencer__control.html" title="(High Speed) SPI command sequencer control command.">stc_hsspi_command_sequencer_control_t</a>* pstcCmdSequence)
<a name="l01152"></a>01152 {
<a name="l01153"></a>01153     uint8_t             u8Index;
<a name="l01154"></a>01154     uint16_t            u16Data;
<a name="l01155"></a>01155     boolean_t           bEndOfListFound;
<a name="l01156"></a>01156     <span class="keyword">volatile</span> uint16_t*  pu16HsSpiRdcsdc;
<a name="l01157"></a>01157     en_result_t         enResult;
<a name="l01158"></a>01158 
<a name="l01159"></a>01159     <span class="comment">// Check for NULL-Pointer</span>
<a name="l01160"></a>01160     <span class="keywordflow">if</span> ((NULL == pstcHsSpi) ||
<a name="l01161"></a>01161         (NULL == pstcCmdSequence)
<a name="l01162"></a>01162        )
<a name="l01163"></a>01163     {
<a name="l01164"></a>01164         <span class="keywordflow">return</span> ErrorInvalidParameter;
<a name="l01165"></a>01165     }
<a name="l01166"></a>01166 
<a name="l01167"></a>01167     <span class="comment">// Check if direct mode is configured</span>
<a name="l01168"></a>01168     <span class="keywordflow">if</span> (0u == pstcHsSpi-&gt;MCTRL_f.CSEN)
<a name="l01169"></a>01169     {
<a name="l01170"></a>01170         <span class="keywordflow">return</span> ErrorInvalidMode;
<a name="l01171"></a>01171     }
<a name="l01172"></a>01172 
<a name="l01173"></a>01173     bEndOfListFound = FALSE; <span class="comment">// Preset to FALSE</span>
<a name="l01174"></a>01174 
<a name="l01175"></a>01175     <span class="comment">// Loop over all possible entries and check for a valid terminator</span>
<a name="l01176"></a>01176     <span class="keywordflow">for</span> (u8Index = 0u; u8Index &lt; 9u; u8Index++)
<a name="l01177"></a>01177     {
<a name="l01178"></a>01178         <span class="keywordflow">if</span> (<a class="code" href="group___hs_spi_group.html#gga8dc47ac4a6460126aafeabbd1fdc568fa05a58920fc10f43382eb47df195857cf" title="End of list, DEC = 1.">HsSpiCmdEndOfList</a> == (pstcCmdSequence + u8Index)-&gt;enCommand)
<a name="l01179"></a>01179         {
<a name="l01180"></a>01180             bEndOfListFound = TRUE;
<a name="l01181"></a>01181             <span class="keywordflow">break</span>;
<a name="l01182"></a>01182         }
<a name="l01183"></a>01183     }
<a name="l01184"></a>01184 
<a name="l01185"></a>01185     <span class="comment">// If no end-of-list terminator found</span>
<a name="l01186"></a>01186     <span class="keywordflow">if</span> (FALSE == bEndOfListFound)
<a name="l01187"></a>01187     {
<a name="l01188"></a>01188         <span class="keywordflow">return</span> ErrorInvalidParameter;
<a name="l01189"></a>01189     }
<a name="l01190"></a>01190     
<a name="l01191"></a>01191     <span class="comment">// Note that there are more limitations regarding the command</span>
<a name="l01192"></a>01192     <span class="comment">// sequence which are not checked here. Refer to the Hardware Manual!</span>
<a name="l01193"></a>01193     
<a name="l01194"></a>01194     enResult = <a class="code" href="group___hs_spi_group.html#ga14b83b69bca9c376d382ea131ccbc98b" title="Globally disable HS-SPI module by clearing bit MEN.">HsSpi_ModuleDisable</a>(pstcHsSpi); <span class="comment">// Disable module before changes are made</span>
<a name="l01195"></a>01195     <span class="comment">//.... Check if operation timed out</span>
<a name="l01196"></a>01196     <span class="keywordflow">if</span>(Ok != enResult)
<a name="l01197"></a>01197     {
<a name="l01198"></a>01198       <span class="keywordflow">return</span> Error;
<a name="l01199"></a>01199     }
<a name="l01200"></a>01200     
<a name="l01201"></a>01201     <span class="comment">// Set configuration register.</span>
<a name="l01202"></a>01202     pu16HsSpiRdcsdc = &amp;pstcHsSpi-&gt;RDCSDC0;
<a name="l01203"></a>01203 
<a name="l01204"></a>01204     <span class="comment">// Loop over all possible &quot;real&quot; commands</span>
<a name="l01205"></a>01205     <span class="keywordflow">for</span>(u8Index = 0u; u8Index &lt; 8u; u8Index++)
<a name="l01206"></a>01206     {
<a name="l01207"></a>01207         <span class="keywordflow">switch</span> ((pstcCmdSequence + u8Index)-&gt;enCommand)
<a name="l01208"></a>01208         {
<a name="l01209"></a>01209             <span class="keywordflow">case</span> <a class="code" href="group___hs_spi_group.html#gga8dc47ac4a6460126aafeabbd1fdc568fae5f75e18e04a8df14013ab98dcdccf75" title="Data &quot;as it is&quot;, no decoding, DEC = 0.">HsSpiCmdTransmitData</a>:
<a name="l01210"></a>01210                 u16Data = ((pstcCmdSequence + u8Index)-&gt;u8Data &lt;&lt; 8u);
<a name="l01211"></a>01211                 <span class="keywordflow">break</span>;
<a name="l01212"></a>01212 
<a name="l01213"></a>01213             <span class="keywordflow">case</span> <a class="code" href="group___hs_spi_group.html#gga8dc47ac4a6460126aafeabbd1fdc568fadeab684dd29efd877829fba792874e5c">HsSpiCmdTransmitHighZStateNibble</a>:
<a name="l01214"></a>01214                 u16Data   = (pstcCmdSequence + u8Index)-&gt;u8Data;
<a name="l01215"></a>01215                 u16Data  &amp;= 0xF0u; <span class="comment">// Only higher nibble used</span>
<a name="l01216"></a>01216                 u16Data  |= 0x05u; <span class="comment">// Control High-Z nibble</span>
<a name="l01217"></a>01217                 u16Data &lt;&lt;= 8u;    <span class="comment">// Make it the high byte</span>
<a name="l01218"></a>01218                 u16Data  |= 1u;    <span class="comment">// Set DECode bit</span>
<a name="l01219"></a>01219                 <span class="keywordflow">break</span>;
<a name="l01220"></a>01220 
<a name="l01221"></a>01221             <span class="keywordflow">case</span> <a class="code" href="group___hs_spi_group.html#gga8dc47ac4a6460126aafeabbd1fdc568fa1bcea10a343f2fa353cc2015403a5997" title="High-Z byte, output signals are tri-stated for 1 byte time, DEC = 1.">HsSpiCmdTransmitHighZStateByte</a>:
<a name="l01222"></a>01222                 u16Data   = 0x04u; <span class="comment">// Control High-Z Byte</span>
<a name="l01223"></a>01223                 u16Data &lt;&lt;= 8u;    <span class="comment">// Make it the high byte</span>
<a name="l01224"></a>01224                 u16Data  |= 1u;    <span class="comment">// Set DECode bit</span>
<a name="l01225"></a>01225                 <span class="keywordflow">break</span>;
<a name="l01226"></a>01226 
<a name="l01227"></a>01227             <span class="keywordflow">default</span>:
<a name="l01228"></a>01228                 u16Data = ((pstcCmdSequence + u8Index)-&gt;enCommand &lt;&lt; 8u);
<a name="l01229"></a>01229                 u16Data |= 1u;  <span class="comment">// Set DECode bit</span>
<a name="l01230"></a>01230         }
<a name="l01231"></a>01231         
<a name="l01232"></a>01232         <span class="comment">// Transfer protocol</span>
<a name="l01233"></a>01233         <span class="keywordflow">switch</span> ((pstcCmdSequence + u8Index)-&gt;enTransferProtocol)
<a name="l01234"></a>01234         {
<a name="l01235"></a>01235           <span class="keywordflow">case</span> <a class="code" href="group___hs_spi_group.html#ggaf2e0c992ca2c70c5cb5781db226ee731a80981f1b59dfc2f20c6407b84e4de428" title="Serial interface bit width complies with HSSPIn_CSCFG:MDM[1:0] setting.">HsSpiSerialIf</a>:
<a name="l01236"></a>01236             u16Data &amp;= 0xFFF9u; <span class="comment">// TRP[1:0] = 2b00</span>
<a name="l01237"></a>01237             <span class="keywordflow">break</span>;
<a name="l01238"></a>01238           <span class="keywordflow">case</span> <a class="code" href="group___hs_spi_group.html#ggaf2e0c992ca2c70c5cb5781db226ee731a1204115535489dfeaa2286fdacf732ac" title="Dual-bit mode.">HsSpiDualBitMode</a>:
<a name="l01239"></a>01239             u16Data &amp;= 0xFFF9u;
<a name="l01240"></a>01240             u16Data |= 0x0002u; <span class="comment">// TRP[1:0] = 2b01</span>
<a name="l01241"></a>01241             <span class="keywordflow">break</span>;
<a name="l01242"></a>01242           <span class="keywordflow">case</span> <a class="code" href="group___hs_spi_group.html#ggaf2e0c992ca2c70c5cb5781db226ee731a21fbd83d72fb89f8c34dcd1c33622292" title="Quad-bit mode.">HsSpiQuadBitMode</a>:
<a name="l01243"></a>01243             u16Data &amp;= 0xFFF9u;
<a name="l01244"></a>01244             u16Data |= 0x0004u; <span class="comment">// TRP[1:0] = 2b10</span>
<a name="l01245"></a>01245             <span class="keywordflow">break</span>;
<a name="l01246"></a>01246           <span class="keywordflow">case</span> <a class="code" href="group___hs_spi_group.html#ggaf2e0c992ca2c70c5cb5781db226ee731a0087aa27e32ef136c6633fa4f7eba230" title="Single-bit mode.">HsSpiSingleBitMode</a>:
<a name="l01247"></a>01247             u16Data |= 0x0006u; <span class="comment">// TRP[1:0] = 2b11</span>
<a name="l01248"></a>01248             <span class="keywordflow">break</span>;
<a name="l01249"></a>01249           <span class="keywordflow">default</span>:
<a name="l01250"></a>01250             <span class="keywordflow">return</span> ErrorInvalidParameter;
<a name="l01251"></a>01251         }     
<a name="l01252"></a>01252         
<a name="l01253"></a>01253         <span class="keywordflow">if</span> (TRUE == ((pstcCmdSequence + u8Index)-&gt;bCont))
<a name="l01254"></a>01254         {
<a name="l01255"></a>01255           u16Data |= 0x0008u;
<a name="l01256"></a>01256         }
<a name="l01257"></a>01257         <span class="keywordflow">else</span>
<a name="l01258"></a>01258         {
<a name="l01259"></a>01259           u16Data &amp;= 0xFFF7u;
<a name="l01260"></a>01260         }
<a name="l01261"></a>01261         
<a name="l01262"></a>01262         <span class="comment">// Write data and/or command</span>
<a name="l01263"></a>01263         pu16HsSpiRdcsdc[u8Index] = u16Data;
<a name="l01264"></a>01264 
<a name="l01265"></a>01265         <span class="comment">// Stop, if end of list is reached</span>
<a name="l01266"></a>01266         <span class="keywordflow">if</span> (<a class="code" href="group___hs_spi_group.html#gga8dc47ac4a6460126aafeabbd1fdc568fa05a58920fc10f43382eb47df195857cf" title="End of list, DEC = 1.">HsSpiCmdEndOfList</a> == (pstcCmdSequence + u8Index)-&gt;enCommand)
<a name="l01267"></a>01267         {
<a name="l01268"></a>01268             <span class="keywordflow">break</span>;
<a name="l01269"></a>01269         }
<a name="l01270"></a>01270     } <span class="comment">// for(u8Index = 0u; u8Index &lt; 8u; u8Index++)</span>
<a name="l01271"></a>01271 
<a name="l01272"></a>01272     enResult = <a class="code" href="group___hs_spi_group.html#gacffe258666aff8b6d4d2d29ddab17253" title="Globally enable SPI module by setting bit MEN.">HsSpi_ModuleEnable</a>(pstcHsSpi);
<a name="l01273"></a>01273     <span class="comment">//.... Check if operation timed out</span>
<a name="l01274"></a>01274     <span class="keywordflow">if</span>(Ok != enResult)
<a name="l01275"></a>01275     {
<a name="l01276"></a>01276       <span class="keywordflow">return</span> Error;
<a name="l01277"></a>01277     }
<a name="l01278"></a>01278 
<a name="l01279"></a>01279     <span class="keywordflow">return</span> Ok;
<a name="l01280"></a>01280 } <span class="comment">// HsSpi_SetReadCommandSequence</span>
<a name="l01281"></a>01281 
<a name="l01305"></a><a class="code" href="group___hs_spi_group.html#ga9a629dae254e331170b5605a2992a186">01305</a> en_result_t <a class="code" href="group___hs_spi_group.html#ga9a629dae254e331170b5605a2992a186" title="Set write command sequence for command sequencer mode.">HsSpi_SetWriteCommandSequence</a>(<span class="keyword">volatile</span> <a class="code" href="group___hs_spi_group.html#gabf9239d572714b9709b8b01844dfe84f">stc_hsspin_t</a>* pstcHsSpi, <span class="keyword">const</span> <a class="code" href="structstc__hsspi__command__sequencer__control.html" title="(High Speed) SPI command sequencer control command.">stc_hsspi_command_sequencer_control_t</a>* pstcCmdSequence)
<a name="l01306"></a>01306 {
<a name="l01307"></a>01307     uint8_t             u8Index;
<a name="l01308"></a>01308     uint16_t            u16Data;
<a name="l01309"></a>01309     boolean_t           bEndOfListFound;
<a name="l01310"></a>01310     <span class="keyword">volatile</span> uint16_t*  pu16HsSpiWrcsdc;
<a name="l01311"></a>01311     en_result_t         enResult;
<a name="l01312"></a>01312 
<a name="l01313"></a>01313     <span class="comment">// Check for NULL-Pointer</span>
<a name="l01314"></a>01314     <span class="keywordflow">if</span> ((NULL == pstcHsSpi) ||
<a name="l01315"></a>01315         (NULL == pstcCmdSequence)
<a name="l01316"></a>01316        )
<a name="l01317"></a>01317     {
<a name="l01318"></a>01318         <span class="keywordflow">return</span> ErrorInvalidParameter;
<a name="l01319"></a>01319     }
<a name="l01320"></a>01320 
<a name="l01321"></a>01321     <span class="comment">// Check if direct mode is configured</span>
<a name="l01322"></a>01322     <span class="keywordflow">if</span> (0u == pstcHsSpi-&gt;MCTRL_f.CSEN)
<a name="l01323"></a>01323     {
<a name="l01324"></a>01324         <span class="keywordflow">return</span> ErrorInvalidMode;
<a name="l01325"></a>01325     }
<a name="l01326"></a>01326 
<a name="l01327"></a>01327     bEndOfListFound = FALSE; <span class="comment">// Preset to FALSE</span>
<a name="l01328"></a>01328 
<a name="l01329"></a>01329     <span class="comment">// Loop over all possible entries and check for a valid terminator</span>
<a name="l01330"></a>01330     <span class="keywordflow">for</span> (u8Index = 0u; u8Index &lt; 9u; u8Index++)
<a name="l01331"></a>01331     {
<a name="l01332"></a>01332         <span class="keywordflow">if</span> (<a class="code" href="group___hs_spi_group.html#gga8dc47ac4a6460126aafeabbd1fdc568fa05a58920fc10f43382eb47df195857cf" title="End of list, DEC = 1.">HsSpiCmdEndOfList</a> == (pstcCmdSequence + u8Index)-&gt;enCommand)
<a name="l01333"></a>01333         {
<a name="l01334"></a>01334             bEndOfListFound = TRUE;
<a name="l01335"></a>01335             <span class="keywordflow">break</span>;
<a name="l01336"></a>01336         }
<a name="l01337"></a>01337     }
<a name="l01338"></a>01338     
<a name="l01339"></a>01339     <span class="comment">// If no end-of-list terminator found</span>
<a name="l01340"></a>01340     <span class="keywordflow">if</span> (FALSE == bEndOfListFound)
<a name="l01341"></a>01341     {
<a name="l01342"></a>01342         <span class="keywordflow">return</span> ErrorInvalidParameter;
<a name="l01343"></a>01343     }
<a name="l01344"></a>01344     
<a name="l01345"></a>01345     <span class="comment">// Note that there are more limitations regarding the command</span>
<a name="l01346"></a>01346     <span class="comment">// sequence which are not checked here. Refer to the Hardware Manual!</span>
<a name="l01347"></a>01347 
<a name="l01348"></a>01348     enResult = <a class="code" href="group___hs_spi_group.html#ga14b83b69bca9c376d382ea131ccbc98b" title="Globally disable HS-SPI module by clearing bit MEN.">HsSpi_ModuleDisable</a>(pstcHsSpi); <span class="comment">// Disable module before changes are made</span>
<a name="l01349"></a>01349     <span class="comment">//.... Check if operation timed out</span>
<a name="l01350"></a>01350     <span class="keywordflow">if</span>(Ok != enResult)
<a name="l01351"></a>01351     {
<a name="l01352"></a>01352       <span class="keywordflow">return</span> Error;
<a name="l01353"></a>01353     }
<a name="l01354"></a>01354 
<a name="l01355"></a>01355     <span class="comment">// Set configuration register.</span>
<a name="l01356"></a>01356     pu16HsSpiWrcsdc = &amp;pstcHsSpi-&gt;WRCSDC0;
<a name="l01357"></a>01357 
<a name="l01358"></a>01358     <span class="comment">// Loop over all possible &quot;real&quot; commands</span>
<a name="l01359"></a>01359     <span class="keywordflow">for</span>(u8Index = 0u; u8Index &lt; 8u; u8Index++)
<a name="l01360"></a>01360     {
<a name="l01361"></a>01361         <span class="keywordflow">switch</span> ((pstcCmdSequence + u8Index)-&gt;enCommand)
<a name="l01362"></a>01362         {
<a name="l01363"></a>01363             <span class="keywordflow">case</span> <a class="code" href="group___hs_spi_group.html#gga8dc47ac4a6460126aafeabbd1fdc568fae5f75e18e04a8df14013ab98dcdccf75" title="Data &quot;as it is&quot;, no decoding, DEC = 0.">HsSpiCmdTransmitData</a>:
<a name="l01364"></a>01364                 u16Data = ((pstcCmdSequence + u8Index)-&gt;u8Data &lt;&lt; 8u);
<a name="l01365"></a>01365                 <span class="keywordflow">break</span>;
<a name="l01366"></a>01366 
<a name="l01367"></a>01367             <span class="keywordflow">case</span> <a class="code" href="group___hs_spi_group.html#gga8dc47ac4a6460126aafeabbd1fdc568fadeab684dd29efd877829fba792874e5c">HsSpiCmdTransmitHighZStateNibble</a>:
<a name="l01368"></a>01368                 u16Data   = (pstcCmdSequence + u8Index)-&gt;u8Data;
<a name="l01369"></a>01369                 u16Data  &amp;= 0xF0u; <span class="comment">// Only higher nibble used</span>
<a name="l01370"></a>01370                 u16Data  |= 0x05u; <span class="comment">// Control High_z nibble</span>
<a name="l01371"></a>01371                 u16Data &lt;&lt;= 8u;    <span class="comment">// Make it the high byte</span>
<a name="l01372"></a>01372                 u16Data  |= 1u;    <span class="comment">// Set DECode bit</span>
<a name="l01373"></a>01373                 <span class="keywordflow">break</span>;
<a name="l01374"></a>01374 
<a name="l01375"></a>01375             <span class="keywordflow">case</span> <a class="code" href="group___hs_spi_group.html#gga8dc47ac4a6460126aafeabbd1fdc568fa1bcea10a343f2fa353cc2015403a5997" title="High-Z byte, output signals are tri-stated for 1 byte time, DEC = 1.">HsSpiCmdTransmitHighZStateByte</a>:
<a name="l01376"></a>01376                 u16Data   = 0x04u; <span class="comment">// Control High-Z Byte</span>
<a name="l01377"></a>01377                 u16Data &lt;&lt;= 8u;    <span class="comment">// Make it the high byte</span>
<a name="l01378"></a>01378                 u16Data  |= 1u;    <span class="comment">// Set DECode bit</span>
<a name="l01379"></a>01379                 <span class="keywordflow">break</span>;
<a name="l01380"></a>01380 
<a name="l01381"></a>01381             <span class="keywordflow">default</span>:
<a name="l01382"></a>01382                 u16Data = ((pstcCmdSequence + u8Index)-&gt;enCommand &lt;&lt; 8u);
<a name="l01383"></a>01383                 u16Data |= 1u;  <span class="comment">// Set DECode bit</span>
<a name="l01384"></a>01384         }
<a name="l01385"></a>01385 
<a name="l01386"></a>01386         <span class="comment">// Transfer protocol</span>
<a name="l01387"></a>01387         <span class="keywordflow">switch</span> ((pstcCmdSequence + u8Index)-&gt;enTransferProtocol)
<a name="l01388"></a>01388         {
<a name="l01389"></a>01389           <span class="keywordflow">case</span> <a class="code" href="group___hs_spi_group.html#ggaf2e0c992ca2c70c5cb5781db226ee731a80981f1b59dfc2f20c6407b84e4de428" title="Serial interface bit width complies with HSSPIn_CSCFG:MDM[1:0] setting.">HsSpiSerialIf</a>:
<a name="l01390"></a>01390             u16Data &amp;= 0xFFF9u; <span class="comment">// TRP[1:0] = 2b00</span>
<a name="l01391"></a>01391             <span class="keywordflow">break</span>;
<a name="l01392"></a>01392           <span class="keywordflow">case</span> <a class="code" href="group___hs_spi_group.html#ggaf2e0c992ca2c70c5cb5781db226ee731a1204115535489dfeaa2286fdacf732ac" title="Dual-bit mode.">HsSpiDualBitMode</a>:
<a name="l01393"></a>01393             u16Data &amp;= 0xFFF9u;
<a name="l01394"></a>01394             u16Data |= 0x0002u; <span class="comment">// TRP[1:0] = 2b01</span>
<a name="l01395"></a>01395             <span class="keywordflow">break</span>;
<a name="l01396"></a>01396           <span class="keywordflow">case</span> <a class="code" href="group___hs_spi_group.html#ggaf2e0c992ca2c70c5cb5781db226ee731a21fbd83d72fb89f8c34dcd1c33622292" title="Quad-bit mode.">HsSpiQuadBitMode</a>:
<a name="l01397"></a>01397             u16Data &amp;= 0xFFF9u;
<a name="l01398"></a>01398             u16Data |= 0x0004u; <span class="comment">// TRP[1:0] = 2b10</span>
<a name="l01399"></a>01399             <span class="keywordflow">break</span>;
<a name="l01400"></a>01400           <span class="keywordflow">case</span> <a class="code" href="group___hs_spi_group.html#ggaf2e0c992ca2c70c5cb5781db226ee731a0087aa27e32ef136c6633fa4f7eba230" title="Single-bit mode.">HsSpiSingleBitMode</a>:
<a name="l01401"></a>01401             u16Data |= 0x0006u; <span class="comment">// TRP[1:0] = 2b11</span>
<a name="l01402"></a>01402             <span class="keywordflow">break</span>;
<a name="l01403"></a>01403           <span class="keywordflow">default</span>:
<a name="l01404"></a>01404             <span class="keywordflow">return</span> ErrorInvalidParameter;
<a name="l01405"></a>01405         }     
<a name="l01406"></a>01406         
<a name="l01407"></a>01407         <span class="keywordflow">if</span> (TRUE == ((pstcCmdSequence + u8Index)-&gt;bCont))
<a name="l01408"></a>01408         {
<a name="l01409"></a>01409           u16Data |= 0x0008u;
<a name="l01410"></a>01410         }
<a name="l01411"></a>01411         <span class="keywordflow">else</span>
<a name="l01412"></a>01412         {
<a name="l01413"></a>01413           u16Data &amp;= 0xFFF7u;
<a name="l01414"></a>01414         }
<a name="l01415"></a>01415         
<a name="l01416"></a>01416         <span class="comment">// Write data and/or command</span>
<a name="l01417"></a>01417         pu16HsSpiWrcsdc[u8Index] = u16Data;
<a name="l01418"></a>01418 
<a name="l01419"></a>01419         <span class="comment">// Stop, if end of list is reached</span>
<a name="l01420"></a>01420         <span class="keywordflow">if</span>((pstcCmdSequence + u8Index)-&gt;enCommand == <a class="code" href="group___hs_spi_group.html#gga8dc47ac4a6460126aafeabbd1fdc568fa05a58920fc10f43382eb47df195857cf" title="End of list, DEC = 1.">HsSpiCmdEndOfList</a>)
<a name="l01421"></a>01421         {
<a name="l01422"></a>01422             <span class="keywordflow">break</span>;
<a name="l01423"></a>01423         }
<a name="l01424"></a>01424     } <span class="comment">// for(u8Index = 0u; u8Index &lt; 8u; u8Index++)</span>
<a name="l01425"></a>01425 
<a name="l01426"></a>01426     enResult = <a class="code" href="group___hs_spi_group.html#gacffe258666aff8b6d4d2d29ddab17253" title="Globally enable SPI module by setting bit MEN.">HsSpi_ModuleEnable</a>(pstcHsSpi);
<a name="l01427"></a>01427     <span class="comment">//.... Check if operation timed out</span>
<a name="l01428"></a>01428     <span class="keywordflow">if</span>(Ok != enResult)
<a name="l01429"></a>01429     {
<a name="l01430"></a>01430       <span class="keywordflow">return</span> Error;
<a name="l01431"></a>01431     }
<a name="l01432"></a>01432 
<a name="l01433"></a>01433     <span class="keywordflow">return</span> Ok;
<a name="l01434"></a>01434 } <span class="comment">// HsSpi_SetWriteCommandSequence</span>
<a name="l01435"></a>01435 
<a name="l01475"></a><a class="code" href="group___hs_spi_group.html#gaa6ac19b806d33be56ced3f0526fc7e74">01475</a> en_result_t <a class="code" href="group___hs_spi_group.html#gaa6ac19b806d33be56ced3f0526fc7e74" title="Starts transfer in legacy mode and then switches to quad mode.">HsSpi_MultiModeTransfer</a>(<span class="keyword">volatile</span> <a class="code" href="group___hs_spi_group.html#gabf9239d572714b9709b8b01844dfe84f">stc_hsspin_t</a>* pstcHsSpi, uint8_t u8DeviceNumber, <span class="keyword">const</span> uint8_t* pu8LegacyData, uint8_t u8LegacyTxSize, <span class="keyword">const</span> uint8_t* pu8TxData, uint8_t u8TxSize, uint8_t* pu8RxData, uint8_t u8RxSize)
<a name="l01476"></a>01476 {
<a name="l01477"></a>01477     <a class="code" href="structstc__hsspi__intern__data.html" title="HS-SPI instance internal data, storing internal information for each enabled HS-SPI instance...">stc_hsspi_intern_data_t</a>* pstcHsSpiInternData;
<a name="l01478"></a>01478     uint8_t u8Index;
<a name="l01479"></a>01479     uint8_t u8TrpBackup;
<a name="l01480"></a>01480 
<a name="l01481"></a>01481     <span class="comment">// Check for NULL-Pointer</span>
<a name="l01482"></a>01482     <span class="keywordflow">if</span> ((NULL == pstcHsSpi) ||
<a name="l01483"></a>01483         (NULL == pu8TxData)
<a name="l01484"></a>01484        )
<a name="l01485"></a>01485     {
<a name="l01486"></a>01486         <span class="keywordflow">return</span> ErrorInvalidParameter;
<a name="l01487"></a>01487     }
<a name="l01488"></a>01488 
<a name="l01489"></a>01489     <span class="comment">// Get ptr to internal data struct ...</span>
<a name="l01490"></a>01490     pstcHsSpiInternData = <a class="code" href="group___hs_spi_group.html#ga075c13e0ec20570f5dce624c7daac457" title="Return the internal data for a certain HS-SPI instance.">HsSpiGetInternDataPtr</a>(pstcHsSpi);
<a name="l01491"></a>01491     <span class="comment">// ... and check</span>
<a name="l01492"></a>01492     <span class="keywordflow">if</span> (NULL == pstcHsSpiInternData)
<a name="l01493"></a>01493     {
<a name="l01494"></a>01494         <span class="keywordflow">return</span> ErrorInvalidParameter;
<a name="l01495"></a>01495     }
<a name="l01496"></a>01496 
<a name="l01497"></a>01497     <span class="comment">// Check for slave number in range</span>
<a name="l01498"></a>01498     <span class="keywordflow">if</span> (u8DeviceNumber &gt; 3u)
<a name="l01499"></a>01499     {
<a name="l01500"></a>01500         <span class="keywordflow">return</span> ErrorInvalidParameter;
<a name="l01501"></a>01501     }
<a name="l01502"></a>01502 
<a name="l01503"></a>01503     <span class="comment">// Check for legacy data pointer</span>
<a name="l01504"></a>01504     <span class="keywordflow">if</span> ((u8LegacyTxSize &gt; 0u) &amp;&amp;
<a name="l01505"></a>01505         (NULL == pu8LegacyData)
<a name="l01506"></a>01506        )
<a name="l01507"></a>01507     {
<a name="l01508"></a>01508         <span class="keywordflow">return</span> ErrorInvalidParameter;
<a name="l01509"></a>01509     }
<a name="l01510"></a>01510     
<a name="l01511"></a>01511     <span class="comment">// Check for valid quad transfer size</span>
<a name="l01512"></a>01512     <span class="keywordflow">if</span> ((0u == u8TxSize) ||
<a name="l01513"></a>01513         (u8TxSize &gt; <a class="code" href="group___hs_spi_group.html#gab176ed4b683a2e6e88ea789352119f44" title="Transmit and receive maximum FIFO depth.">HS_SPI_MAX_FIFO_DEPTH</a>)
<a name="l01514"></a>01514        )
<a name="l01515"></a>01515     {
<a name="l01516"></a>01516         <span class="keywordflow">return</span> ErrorInvalidParameter;
<a name="l01517"></a>01517     }
<a name="l01518"></a>01518 
<a name="l01519"></a>01519     <span class="comment">// Check for valid quad receive size</span>
<a name="l01520"></a>01520     <span class="keywordflow">if</span> (u8RxSize &gt; <a class="code" href="group___hs_spi_group.html#gab176ed4b683a2e6e88ea789352119f44" title="Transmit and receive maximum FIFO depth.">HS_SPI_MAX_FIFO_DEPTH</a>)
<a name="l01521"></a>01521     {
<a name="l01522"></a>01522         <span class="keywordflow">return</span> ErrorInvalidParameter;
<a name="l01523"></a>01523     }
<a name="l01524"></a>01524 
<a name="l01525"></a>01525     <span class="comment">// Check if there are is a pending transmission</span>
<a name="l01526"></a>01526     <span class="keywordflow">if</span> (pstcHsSpi-&gt;DMSTATUS_f.TXACTIVE != 0u)
<a name="l01527"></a>01527     {
<a name="l01528"></a>01528         <span class="keywordflow">return</span> ErrorOperationInProgress;
<a name="l01529"></a>01529     }
<a name="l01530"></a>01530 
<a name="l01531"></a>01531     <span class="comment">// Backup current protocol mode</span>
<a name="l01532"></a>01532     u8TrpBackup = pstcHsSpi-&gt;DMTRP;
<a name="l01533"></a>01533 
<a name="l01534"></a>01534     <span class="comment">// Store receive buffer pointer</span>
<a name="l01535"></a>01535     pstcHsSpiInternData-&gt;<a class="code" href="structstc__hsspi__intern__data.html#ad058a84e4a88cd35d7ed5f83bc26ce1f">pu8RXBuffer</a> = pu8RxData;
<a name="l01536"></a>01536 
<a name="l01537"></a>01537     <span class="comment">// Flush transmit and receive FIFOs</span>
<a name="l01538"></a>01538     pstcHsSpi-&gt;FIFOCFG_f.TXFLSH = 1u;
<a name="l01539"></a>01539     pstcHsSpi-&gt;FIFOCFG_f.RXFLSH = 1u;
<a name="l01540"></a>01540 
<a name="l01541"></a>01541     <span class="comment">// Select current device for transmission.</span>
<a name="l01542"></a>01542     pstcHsSpi-&gt;DMPSEL_f.PSEL = u8DeviceNumber;
<a name="l01543"></a>01543 
<a name="l01544"></a>01544     <span class="comment">// In half-duplex mode the number of bytes in this transaction is the sum of TX and RX</span>
<a name="l01545"></a>01545     pstcHsSpi-&gt;DMBCC = (uint16_t)(u8LegacyTxSize + u8TxSize + u8RxSize);
<a name="l01546"></a>01546 
<a name="l01547"></a>01547     <span class="comment">// Trigger start of transfer.</span>
<a name="l01548"></a>01548     pstcHsSpi-&gt;DMSTART = 1u;
<a name="l01549"></a>01549         
<a name="l01550"></a>01550     <span class="keywordflow">if</span> (u8LegacyTxSize &gt; 0u)
<a name="l01551"></a>01551     {
<a name="l01552"></a>01552         <span class="comment">// Set Transfer Protocol to direct mode TX only</span>
<a name="l01553"></a>01553         pstcHsSpi-&gt;DMTRP = <a class="code" href="group___hs_spi_group.html#ga5b38151bd5ad8b5ac5075314eb8bba0d" title="Transmit only, in single mode.">HSSPI_DIRECT_MODE_TX_ONLY_SINGLE_MODE</a>;
<a name="l01554"></a>01554 
<a name="l01555"></a>01555         <span class="comment">// Fill Fifo with data which must be send in legacy mode</span>
<a name="l01556"></a>01556         <span class="keywordflow">for</span> (u8Index = 0u; u8Index &lt; u8LegacyTxSize; u8Index++)
<a name="l01557"></a>01557         {
<a name="l01558"></a>01558            *((uint8_t*)(&amp;pstcHsSpi-&gt;TXFIFO0)) = (uint8_t)pu8LegacyData[u8Index];
<a name="l01559"></a>01559         }
<a name="l01560"></a>01560         
<a name="l01561"></a>01561         <span class="comment">// Clear &quot;transmit FIFO &amp; shift register&quot; empty flag.</span>
<a name="l01562"></a>01562         pstcHsSpi-&gt;TXC_f.TFEC = 1u;
<a name="l01563"></a>01563         
<a name="l01564"></a>01564         <span class="comment">// Now wait until all data in legacy mode is sent (no more data in FIFO and shift register empty)</span>
<a name="l01565"></a>01565         <span class="keywordflow">while</span> ((pstcHsSpi-&gt;DMSTATUS_f.TXFLEVEL &gt; 0u) ||
<a name="l01566"></a>01566                (pstcHsSpi-&gt;TXF_f.TFES != 1u)
<a name="l01567"></a>01567               )
<a name="l01568"></a>01568         {
<a name="l01569"></a>01569             <a class="code" href="group___p_d_l.html#ga76336ac37d977e02bf0fdbf84b1e3fd1" title="Hook function, which is called in polling loops.">PDL_WAIT_LOOP_HOOK</a>();
<a name="l01570"></a>01570         }
<a name="l01571"></a>01571     }
<a name="l01572"></a>01572     
<a name="l01573"></a>01573     <span class="keywordflow">if</span>(u8RxSize != 0)
<a name="l01574"></a>01574     {
<a name="l01575"></a>01575       <span class="comment">// Use this ONLY in Dual/Quad I/O modes. Comment this line for other modes.</span>
<a name="l01576"></a>01576       <span class="comment">// Set Transfer Protocol to quad mode TX for Fast Read QUAD I/O OPN</span>
<a name="l01577"></a>01577       pstcHsSpi-&gt;DMTRP = <a class="code" href="group___hs_spi_group.html#gaa90edc3bf16fde0cbfdc2293ad194e86" title="Transmit only, in quad mode.">HSSPI_DIRECT_MODE_TX_ONLY_QUAD_MODE</a>;
<a name="l01578"></a>01578     }
<a name="l01579"></a>01579     
<a name="l01580"></a>01580     <span class="comment">// Flush transmit and receive FIFOs</span>
<a name="l01581"></a>01581     pstcHsSpi-&gt;FIFOCFG_f.TXFLSH = 1u;
<a name="l01582"></a>01582     pstcHsSpi-&gt;FIFOCFG_f.RXFLSH = 1u;
<a name="l01583"></a>01583     
<a name="l01584"></a>01584     <span class="comment">// Fill FIFO with new data</span>
<a name="l01585"></a>01585     <span class="keywordflow">for</span> (u8Index = 0u; u8Index &lt; u8TxSize; u8Index++)
<a name="l01586"></a>01586     {
<a name="l01587"></a>01587       *((uint8_t*)(&amp;pstcHsSpi-&gt;TXFIFO0)) = (uint8_t)pu8TxData[u8Index];
<a name="l01588"></a>01588     }
<a name="l01589"></a>01589     
<a name="l01590"></a>01590     <span class="comment">// Clear &quot;transmit FIFO &amp; shift register&quot; empty flag.</span>
<a name="l01591"></a>01591     pstcHsSpi-&gt;TXC_f.TFEC = 1u;
<a name="l01592"></a>01592 
<a name="l01593"></a>01593     <span class="comment">// Wait until quad transfer is finished (no more data in FIFO and shift register empty)</span>
<a name="l01594"></a>01594     <span class="keywordflow">while</span> ((pstcHsSpi-&gt;DMSTATUS_f.TXFLEVEL &gt; 0u) ||
<a name="l01595"></a>01595            (pstcHsSpi-&gt;TXF_f.TFES != 1u)
<a name="l01596"></a>01596           )
<a name="l01597"></a>01597     {
<a name="l01598"></a>01598         <a class="code" href="group___p_d_l.html#ga76336ac37d977e02bf0fdbf84b1e3fd1" title="Hook function, which is called in polling loops.">PDL_WAIT_LOOP_HOOK</a>();
<a name="l01599"></a>01599     }
<a name="l01600"></a>01600 
<a name="l01601"></a>01601     <span class="comment">// If no receive data is requested function can return here</span>
<a name="l01602"></a>01602     <span class="keywordflow">if</span> ((NULL == pu8RxData) || 
<a name="l01603"></a>01603         (0u == u8RxSize)
<a name="l01604"></a>01604        )
<a name="l01605"></a>01605     {
<a name="l01606"></a>01606         <span class="comment">// Wait unit all data went out before restoring mode</span>
<a name="l01607"></a>01607         <span class="keywordflow">while</span> (pstcHsSpi-&gt;DMSTATUS_f.TXACTIVE != 0u)
<a name="l01608"></a>01608         {
<a name="l01609"></a>01609             <a class="code" href="group___p_d_l.html#ga76336ac37d977e02bf0fdbf84b1e3fd1" title="Hook function, which is called in polling loops.">PDL_WAIT_LOOP_HOOK</a>();
<a name="l01610"></a>01610         }
<a name="l01611"></a>01611 
<a name="l01612"></a>01612         <span class="comment">// Restore previous mode</span>
<a name="l01613"></a>01613         pstcHsSpi-&gt;DMTRP = u8TrpBackup;
<a name="l01614"></a>01614         <span class="keywordflow">return</span> Ok;
<a name="l01615"></a>01615     }
<a name="l01616"></a>01616 
<a name="l01617"></a>01617     <span class="comment">// Flush transmit and receive FIFOs</span>
<a name="l01618"></a>01618     pstcHsSpi-&gt;FIFOCFG_f.TXFLSH = 1u;
<a name="l01619"></a>01619     pstcHsSpi-&gt;FIFOCFG_f.RXFLSH = 1u;
<a name="l01620"></a>01620     
<a name="l01621"></a>01621     <span class="comment">// Set Transfer Protocol to quad mode RX only</span>
<a name="l01622"></a>01622     pstcHsSpi-&gt;DMTRP = <a class="code" href="group___hs_spi_group.html#ga39d0835a2cee67d26cd6b2c3db326d2e" title="Receive only, in quad mode.">HSSPI_DIRECT_MODE_RX_ONLY_QUAD_MODE</a>;
<a name="l01623"></a>01623     
<a name="l01624"></a>01624     <span class="comment">// By switching to RX only mode the SPI automatically outputs the</span>
<a name="l01625"></a>01625     <span class="comment">// required clocks for the remaining byte count (SPIn_DMBCS)</span>
<a name="l01626"></a>01626 
<a name="l01627"></a>01627     <span class="comment">// Initialise receive buffer index</span>
<a name="l01628"></a>01628     u8Index = 0u;
<a name="l01629"></a>01629     <span class="comment">// Read from the RX FIFO, the FIFO will only contain the number</span>
<a name="l01630"></a>01630     <span class="comment">// of requested data, hence u8Index does not need to be checked</span>
<a name="l01631"></a>01631     <span class="keywordflow">while</span> ((1u == pstcHsSpi-&gt;DMSTATUS_f.RXACTIVE) ||
<a name="l01632"></a>01632            (pstcHsSpi-&gt;DMSTATUS_f.RXFLEVEL &gt; 0u)
<a name="l01633"></a>01633           )
<a name="l01634"></a>01634     {
<a name="l01635"></a>01635         <span class="keywordflow">if</span> (pstcHsSpi-&gt;DMSTATUS_f.RXFLEVEL &gt; 0u)
<a name="l01636"></a>01636         {
<a name="l01637"></a>01637             pu8RxData[u8Index] = *((uint8_t*)(&amp;pstcHsSpi-&gt;RXFIFO0)); 
<a name="l01638"></a>01638             u8Index++;
<a name="l01639"></a>01639         }
<a name="l01640"></a>01640     }
<a name="l01641"></a>01641 
<a name="l01642"></a>01642     <span class="comment">// Restore previous mode</span>
<a name="l01643"></a>01643     pstcHsSpi-&gt;DMTRP = u8TrpBackup;
<a name="l01644"></a>01644 
<a name="l01645"></a>01645     <span class="keywordflow">return</span> Ok;
<a name="l01646"></a>01646 } <span class="comment">// HsSpi_MultiModeTransfer</span>
<a name="l01647"></a>01647 
<a name="l01649"></a>01649 <span class="preprocessor">#endif //#if (defined(PDL_PERIPHERAL_HSSPI_ACTIVE))</span>
<a name="l01650"></a>01650 <span class="preprocessor"></span>
<a name="l01651"></a>01651 <span class="comment">/*****************************************************************************/</span>
<a name="l01652"></a>01652 <span class="comment">/* EOF (not truncated)                                                       */</span>
<a name="l01653"></a>01653 <span class="comment">/*****************************************************************************/</span>
</pre></div></div><!-- contents -->
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="hsspi_8c.html">hsspi.c</a>      </li>

    <li class="footer">Generated on Tue Sep 29 2015 15:06:41 for PDL for FM Family by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
