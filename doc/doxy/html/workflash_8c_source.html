<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>PDL for FM Family: C:/Users/chzhang/Desktop/FM0 MCU/universial PDL/release_v11f_doxy/driver/flash/workflash.c Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>


</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  <td id="projectlogo"><img alt="Logo" src="products_site_image.png"/></td>
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">PDL for FM Family
   &#160;<span id="projectnumber">Version2.0.0</span>
   </div>
   <div id="projectbrief">FM Peripheral Driver Library</div>
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('workflash_8c.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">C:/Users/chzhang/Desktop/FM0 MCU/universial PDL/release_v11f_doxy/driver/flash/workflash.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="workflash_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*******************************************************************************</span>
<a name="l00002"></a>00002 <span class="comment">* Copyright (C) 2013 Spansion LLC. All Rights Reserved. </span>
<a name="l00003"></a>00003 <span class="comment">*</span>
<a name="l00004"></a>00004 <span class="comment">* This software is owned and published by: </span>
<a name="l00005"></a>00005 <span class="comment">* Spansion LLC, 915 DeGuigne Dr. Sunnyvale, CA  94088-3453 (&quot;Spansion&quot;).</span>
<a name="l00006"></a>00006 <span class="comment">*</span>
<a name="l00007"></a>00007 <span class="comment">* BY DOWNLOADING, INSTALLING OR USING THIS SOFTWARE, YOU AGREE TO BE BOUND </span>
<a name="l00008"></a>00008 <span class="comment">* BY ALL THE TERMS AND CONDITIONS OF THIS AGREEMENT.</span>
<a name="l00009"></a>00009 <span class="comment">*</span>
<a name="l00010"></a>00010 <span class="comment">* This software contains source code for use with Spansion </span>
<a name="l00011"></a>00011 <span class="comment">* components. This software is licensed by Spansion to be adapted only </span>
<a name="l00012"></a>00012 <span class="comment">* for use in systems utilizing Spansion components. Spansion shall not be </span>
<a name="l00013"></a>00013 <span class="comment">* responsible for misuse or illegal use of this software for devices not </span>
<a name="l00014"></a>00014 <span class="comment">* supported herein.  Spansion is providing this software &quot;AS IS&quot; and will </span>
<a name="l00015"></a>00015 <span class="comment">* not be responsible for issues arising from incorrect user implementation </span>
<a name="l00016"></a>00016 <span class="comment">* of the software.  </span>
<a name="l00017"></a>00017 <span class="comment">*</span>
<a name="l00018"></a>00018 <span class="comment">* SPANSION MAKES NO WARRANTY, EXPRESS OR IMPLIED, ARISING BY LAW OR OTHERWISE,</span>
<a name="l00019"></a>00019 <span class="comment">* REGARDING THE SOFTWARE (INCLUDING ANY ACOOMPANYING WRITTEN MATERIALS), </span>
<a name="l00020"></a>00020 <span class="comment">* ITS PERFORMANCE OR SUITABILITY FOR YOUR INTENDED USE, INCLUDING, </span>
<a name="l00021"></a>00021 <span class="comment">* WITHOUT LIMITATION, THE IMPLIED WARRANTY OF MERCHANTABILITY, THE IMPLIED </span>
<a name="l00022"></a>00022 <span class="comment">* WARRANTY OF FITNESS FOR A PARTICULAR PURPOSE OR USE, AND THE IMPLIED </span>
<a name="l00023"></a>00023 <span class="comment">* WARRANTY OF NONINFRINGEMENT.  </span>
<a name="l00024"></a>00024 <span class="comment">* SPANSION SHALL HAVE NO LIABILITY (WHETHER IN CONTRACT, WARRANTY, TORT, </span>
<a name="l00025"></a>00025 <span class="comment">* NEGLIGENCE OR OTHERWISE) FOR ANY DAMAGES WHATSOEVER (INCLUDING, WITHOUT </span>
<a name="l00026"></a>00026 <span class="comment">* LIMITATION, DAMAGES FOR LOSS OF BUSINESS PROFITS, BUSINESS INTERRUPTION, </span>
<a name="l00027"></a>00027 <span class="comment">* LOSS OF BUSINESS INFORMATION, OR OTHER PECUNIARY LOSS) ARISING FROM USE OR </span>
<a name="l00028"></a>00028 <span class="comment">* INABILITY TO USE THE SOFTWARE, INCLUDING, WITHOUT LIMITATION, ANY DIRECT, </span>
<a name="l00029"></a>00029 <span class="comment">* INDIRECT, INCIDENTAL, SPECIAL OR CONSEQUENTIAL DAMAGES OR LOSS OF DATA, </span>
<a name="l00030"></a>00030 <span class="comment">* SAVINGS OR PROFITS, </span>
<a name="l00031"></a>00031 <span class="comment">* EVEN IF SPANSION HAS BEEN ADVISED OF THE POSSIBILITY OF SUCH DAMAGES. </span>
<a name="l00032"></a>00032 <span class="comment">* YOU ASSUME ALL RESPONSIBILITIES FOR SELECTION OF THE SOFTWARE TO ACHIEVE YOUR</span>
<a name="l00033"></a>00033 <span class="comment">* INTENDED RESULTS, AND FOR THE INSTALLATION OF, USE OF, AND RESULTS OBTAINED </span>
<a name="l00034"></a>00034 <span class="comment">* FROM, THE SOFTWARE.  </span>
<a name="l00035"></a>00035 <span class="comment">*</span>
<a name="l00036"></a>00036 <span class="comment">* This software may be replicated in part or whole for the licensed use, </span>
<a name="l00037"></a>00037 <span class="comment">* with the restriction that this Disclaimer and Copyright notice must be </span>
<a name="l00038"></a>00038 <span class="comment">* included with each copy of this software, whether used in part or whole, </span>
<a name="l00039"></a>00039 <span class="comment">* at all times.  </span>
<a name="l00040"></a>00040 <span class="comment">*/</span>
<a name="l00041"></a>00041 
<a name="l00042"></a>00042 <span class="comment">/******************************************************************************/</span>
<a name="l00052"></a>00052 <span class="comment">/******************************************************************************/</span>
<a name="l00053"></a>00053 <span class="comment">/* Include files                                                              */</span>
<a name="l00054"></a>00054 <span class="comment">/******************************************************************************/</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &quot;<a class="code" href="workflash_8h.html">workflash.h</a>&quot;</span>
<a name="l00056"></a>00056 
<a name="l00057"></a>00057 <span class="preprocessor">#if defined(PDL_PERIPHERAL_WORK_FLASH_ACTIVE) </span>
<a name="l00058"></a>00058 <span class="preprocessor"></span>
<a name="l00064"></a>00064    
<a name="l00071"></a><a class="code" href="group___work_flash_group.html#ga178452b4e1be4a1f3266ce880a8e0242">00071</a> <span class="preprocessor">#define Flash_Read(addr)        *(volatile uint16_t*)((uint32_t)(addr))</span>
<a name="l00072"></a>00072 <span class="preprocessor"></span>
<a name="l00080"></a><a class="code" href="group___work_flash_group.html#ga20eb3b5e3d3a820662d403bf3340abe1">00080</a> <span class="preprocessor">#define Flash_Write(addr, data) *(volatile uint16_t*)((uint32_t)(addr)) = ( uint16_t)(data)</span>
<a name="l00081"></a>00081 <span class="preprocessor"></span>
<a name="l00082"></a>00082 <span class="comment">/******************************************************************************/</span>
<a name="l00083"></a>00083 <span class="comment">/* Local pre-processor symbols/macros (&#39;#define&#39;)                             */</span>
<a name="l00084"></a>00084 <span class="comment">/******************************************************************************/</span>
<a name="l00085"></a>00085 <span class="keyword">static</span> uint8_t <a class="code" href="group___work_flash_group.html#ga844335d14336062d28a1bc261471270e" title="automatic algorithm of flash memory execution">WFlash_CheckToggle</a>( uint16_t* pAddr );
<a name="l00086"></a>00086 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="group___work_flash_group.html#gaa7bb4322db632558ad7059e1b60a50ca" title="Issue read/reset command.">WFlash_ReadResetCmd</a>(uint16_t* pu16ResetSecAddr);
<a name="l00087"></a>00087 
<a name="l00098"></a><a class="code" href="group___work_flash_group.html#gaa7bb4322db632558ad7059e1b60a50ca">00098</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="group___work_flash_group.html#gaa7bb4322db632558ad7059e1b60a50ca" title="Issue read/reset command.">WFlash_ReadResetCmd</a>(uint16_t* pu16ResetSecAddr)
<a name="l00099"></a>00099 {
<a name="l00100"></a>00100     uint8_t  u8Dummy;
<a name="l00101"></a>00101 
<a name="l00102"></a>00102     <span class="comment">/*  issue read/reset command    */</span>
<a name="l00103"></a>00103     <a class="code" href="group___work_flash_group.html#ga20eb3b5e3d3a820662d403bf3340abe1" title="Wirte a half word data into Flash.">Flash_Write</a>(0x0000u, 0xF0u) ;
<a name="l00104"></a>00104     u8Dummy = <a class="code" href="group___work_flash_group.html#ga178452b4e1be4a1f3266ce880a8e0242" title="Read a half word data from Flash.">Flash_Read</a>(pu16ResetSecAddr) ;
<a name="l00105"></a>00105     <span class="keywordflow">if</span>(u8Dummy)  <span class="comment">/* avoid warning */</span>  
<a name="l00106"></a>00106         ;
<a name="l00107"></a>00107     return ;
<a name="l00108"></a>00108 }
<a name="l00109"></a>00109 
<a name="l00121"></a><a class="code" href="group___work_flash_group.html#ga29f04a445263c151c76cc22101a3a58a">00121</a> en_result_t <a class="code" href="group___work_flash_group.html#ga29f04a445263c151c76cc22101a3a58a" title="Flash chip erase.">WFlash_ChipErase</a>(<span class="keywordtype">void</span>)
<a name="l00122"></a>00122 {
<a name="l00123"></a>00123     en_result_t emRetValue = Ok;
<a name="l00124"></a>00124 <span class="preprocessor">#if (PDL_MCU_CORE != PDL_FM0P_CORE)    </span>
<a name="l00125"></a>00125 <span class="preprocessor"></span>    uint8_t  u8Dummy;
<a name="l00126"></a>00126     FM_WORKFLASH_IF-&gt;WFASZR = 0x00u;
<a name="l00127"></a>00127     u8Dummy = FM_WORKFLASH_IF-&gt;WFASZR;
<a name="l00128"></a>00128     <span class="keywordflow">if</span>(u8Dummy) ;
<a name="l00129"></a>00129 <span class="preprocessor">#endif        </span>
<a name="l00130"></a>00130 <span class="preprocessor"></span>    <a class="code" href="group___work_flash_group.html#ga20eb3b5e3d3a820662d403bf3340abe1" title="Wirte a half word data into Flash.">Flash_Write</a>((<a class="code" href="group___work_flash_group.html#ga47750c7abcf0807643aebd7a8e8c0c26">WFLASH_CODE1</a> | <a class="code" href="group___work_flash_group.html#ga7368f4ecd7d7eeec6eaa974acc7ed729">WFLASH_BASE_ADDR</a>), 0x00AAu);
<a name="l00131"></a>00131     <a class="code" href="group___work_flash_group.html#ga20eb3b5e3d3a820662d403bf3340abe1" title="Wirte a half word data into Flash.">Flash_Write</a>((<a class="code" href="group___work_flash_group.html#ga8017917b06bbe0a2da705e3930095a95">WFLASH_CODE2</a> | <a class="code" href="group___work_flash_group.html#ga7368f4ecd7d7eeec6eaa974acc7ed729">WFLASH_BASE_ADDR</a>), 0x0055u);
<a name="l00132"></a>00132     <a class="code" href="group___work_flash_group.html#ga20eb3b5e3d3a820662d403bf3340abe1" title="Wirte a half word data into Flash.">Flash_Write</a>((<a class="code" href="group___work_flash_group.html#ga47750c7abcf0807643aebd7a8e8c0c26">WFLASH_CODE1</a> | <a class="code" href="group___work_flash_group.html#ga7368f4ecd7d7eeec6eaa974acc7ed729">WFLASH_BASE_ADDR</a>), 0x0080u);
<a name="l00133"></a>00133     <a class="code" href="group___work_flash_group.html#ga20eb3b5e3d3a820662d403bf3340abe1" title="Wirte a half word data into Flash.">Flash_Write</a>((<a class="code" href="group___work_flash_group.html#ga47750c7abcf0807643aebd7a8e8c0c26">WFLASH_CODE1</a> | <a class="code" href="group___work_flash_group.html#ga7368f4ecd7d7eeec6eaa974acc7ed729">WFLASH_BASE_ADDR</a>), 0x00AAu);
<a name="l00134"></a>00134     <a class="code" href="group___work_flash_group.html#ga20eb3b5e3d3a820662d403bf3340abe1" title="Wirte a half word data into Flash.">Flash_Write</a>((<a class="code" href="group___work_flash_group.html#ga8017917b06bbe0a2da705e3930095a95">WFLASH_CODE2</a>| <a class="code" href="group___work_flash_group.html#ga7368f4ecd7d7eeec6eaa974acc7ed729">WFLASH_BASE_ADDR</a>), 0x0055u);
<a name="l00135"></a>00135     <a class="code" href="group___work_flash_group.html#ga20eb3b5e3d3a820662d403bf3340abe1" title="Wirte a half word data into Flash.">Flash_Write</a>((<a class="code" href="group___work_flash_group.html#ga47750c7abcf0807643aebd7a8e8c0c26">WFLASH_CODE1</a> | <a class="code" href="group___work_flash_group.html#ga7368f4ecd7d7eeec6eaa974acc7ed729">WFLASH_BASE_ADDR</a>), 0x0010u);
<a name="l00136"></a>00136 
<a name="l00137"></a>00137      <span class="comment">/*  if execution result of the automatic algorithm of flash memory is abnormally completed  */</span>
<a name="l00138"></a>00138     <span class="keywordflow">if</span>( <a class="code" href="group___work_flash_group.html#ga7a84c85c8623c33d56e1d33145be62ec">WFLASH_CHK_TOGG_ABNORMAL</a> == <a class="code" href="group___work_flash_group.html#ga844335d14336062d28a1bc261471270e" title="automatic algorithm of flash memory execution">WFlash_CheckToggle</a>((uint16_t*)<a class="code" href="group___work_flash_group.html#ga7368f4ecd7d7eeec6eaa974acc7ed729">WFLASH_BASE_ADDR</a>) )
<a name="l00139"></a>00139     {
<a name="l00140"></a>00140         <span class="comment">/*  sending the read/reset command to the reset sector  */</span>
<a name="l00141"></a>00141         <a class="code" href="group___work_flash_group.html#gaa7bb4322db632558ad7059e1b60a50ca" title="Issue read/reset command.">WFlash_ReadResetCmd</a>((uint16_t*)WFLASH_BASE_ADDR) ;
<a name="l00142"></a>00142 
<a name="l00143"></a>00143         <span class="comment">/*  return flash operation abnormally   */</span>
<a name="l00144"></a>00144         emRetValue  = ErrorInvalidParameter ;
<a name="l00145"></a>00145     }
<a name="l00146"></a>00146     
<a name="l00147"></a>00147     <span class="comment">/*  CPU ROM mode setting    */</span>
<a name="l00148"></a>00148 <span class="preprocessor">#if (PDL_MCU_CORE != PDL_FM0P_CORE) </span>
<a name="l00149"></a>00149 <span class="preprocessor"></span>        FM_WORKFLASH_IF-&gt;WFASZR = 0x01u; 
<a name="l00150"></a>00150         u8Dummy = FM_WORKFLASH_IF-&gt;WFASZR;
<a name="l00151"></a>00151 <span class="preprocessor">#endif</span>
<a name="l00152"></a>00152 <span class="preprocessor"></span>
<a name="l00153"></a>00153     <span class="keywordflow">return</span> emRetValue;
<a name="l00154"></a>00154 }
<a name="l00155"></a>00155 
<a name="l00169"></a><a class="code" href="group___work_flash_group.html#gad85869c6dcc73cf1a0a363d8bc66fd36">00169</a> en_result_t <a class="code" href="group___work_flash_group.html#gad85869c6dcc73cf1a0a363d8bc66fd36" title="Flash sector erase.">WFlash_SectorErase</a>(uint16_t* pu16SecAddr)
<a name="l00170"></a>00170 {
<a name="l00171"></a>00171     en_result_t emRetValue = Ok;
<a name="l00172"></a>00172 <span class="preprocessor">#if (PDL_MCU_CORE != PDL_FM0P_CORE)   </span>
<a name="l00173"></a>00173 <span class="preprocessor"></span>    uint8_t  u8Dummy;
<a name="l00174"></a>00174 <span class="preprocessor">#endif</span>
<a name="l00175"></a>00175 <span class="preprocessor"></span><span class="preprocessor">#if (PDL_MCU_CORE != PDL_FM0P_CORE)    </span>
<a name="l00176"></a>00176 <span class="preprocessor"></span>    FM_WORKFLASH_IF-&gt;WFASZR = 0x00u;
<a name="l00177"></a>00177     u8Dummy = FM_WORKFLASH_IF-&gt;WFASZR;
<a name="l00178"></a>00178     <span class="keywordflow">if</span>(u8Dummy) ;
<a name="l00179"></a>00179 <span class="preprocessor">#endif</span>
<a name="l00180"></a>00180 <span class="preprocessor"></span>       
<a name="l00181"></a>00181         <a class="code" href="group___work_flash_group.html#ga20eb3b5e3d3a820662d403bf3340abe1" title="Wirte a half word data into Flash.">Flash_Write</a>((<a class="code" href="group___work_flash_group.html#ga47750c7abcf0807643aebd7a8e8c0c26">WFLASH_CODE1</a> | <a class="code" href="group___work_flash_group.html#ga7368f4ecd7d7eeec6eaa974acc7ed729">WFLASH_BASE_ADDR</a>), 0x00AAu);
<a name="l00182"></a>00182         <a class="code" href="group___work_flash_group.html#ga20eb3b5e3d3a820662d403bf3340abe1" title="Wirte a half word data into Flash.">Flash_Write</a>((<a class="code" href="group___work_flash_group.html#ga8017917b06bbe0a2da705e3930095a95">WFLASH_CODE2</a> | <a class="code" href="group___work_flash_group.html#ga7368f4ecd7d7eeec6eaa974acc7ed729">WFLASH_BASE_ADDR</a>), 0x0055u);
<a name="l00183"></a>00183         <a class="code" href="group___work_flash_group.html#ga20eb3b5e3d3a820662d403bf3340abe1" title="Wirte a half word data into Flash.">Flash_Write</a>((<a class="code" href="group___work_flash_group.html#ga47750c7abcf0807643aebd7a8e8c0c26">WFLASH_CODE1</a> | <a class="code" href="group___work_flash_group.html#ga7368f4ecd7d7eeec6eaa974acc7ed729">WFLASH_BASE_ADDR</a>), 0x0080u);
<a name="l00184"></a>00184         <a class="code" href="group___work_flash_group.html#ga20eb3b5e3d3a820662d403bf3340abe1" title="Wirte a half word data into Flash.">Flash_Write</a>((<a class="code" href="group___work_flash_group.html#ga47750c7abcf0807643aebd7a8e8c0c26">WFLASH_CODE1</a> | <a class="code" href="group___work_flash_group.html#ga7368f4ecd7d7eeec6eaa974acc7ed729">WFLASH_BASE_ADDR</a>), 0x00AAu);
<a name="l00185"></a>00185         <a class="code" href="group___work_flash_group.html#ga20eb3b5e3d3a820662d403bf3340abe1" title="Wirte a half word data into Flash.">Flash_Write</a>((<a class="code" href="group___work_flash_group.html#ga8017917b06bbe0a2da705e3930095a95">WFLASH_CODE2</a> | <a class="code" href="group___work_flash_group.html#ga7368f4ecd7d7eeec6eaa974acc7ed729">WFLASH_BASE_ADDR</a>), 0x0055u);
<a name="l00186"></a>00186         <a class="code" href="group___work_flash_group.html#ga20eb3b5e3d3a820662d403bf3340abe1" title="Wirte a half word data into Flash.">Flash_Write</a>(pu16SecAddr, 0x0030u);
<a name="l00187"></a>00187 
<a name="l00188"></a>00188          <span class="comment">/*  if execution result of the automatic algorithm of flash memory is abnormally completed  */</span>
<a name="l00189"></a>00189         <span class="keywordflow">if</span>( <a class="code" href="group___work_flash_group.html#ga7a84c85c8623c33d56e1d33145be62ec">WFLASH_CHK_TOGG_ABNORMAL</a> == <a class="code" href="group___work_flash_group.html#ga844335d14336062d28a1bc261471270e" title="automatic algorithm of flash memory execution">WFlash_CheckToggle</a>(pu16SecAddr) )
<a name="l00190"></a>00190         {
<a name="l00191"></a>00191             <span class="comment">/*  sending the read/reset command to the reset sector  */</span>
<a name="l00192"></a>00192             <a class="code" href="group___work_flash_group.html#gaa7bb4322db632558ad7059e1b60a50ca" title="Issue read/reset command.">WFlash_ReadResetCmd</a>(pu16SecAddr) ;
<a name="l00193"></a>00193 
<a name="l00194"></a>00194             <span class="comment">/*  return flash operation abnormally   */</span>
<a name="l00195"></a>00195             emRetValue  = ErrorInvalidParameter ;
<a name="l00196"></a>00196         }
<a name="l00197"></a>00197 
<a name="l00198"></a>00198         <span class="comment">/*  CPU ROM mode setting    */</span>
<a name="l00199"></a>00199 <span class="preprocessor">#if (PDL_MCU_CORE != PDL_FM0P_CORE) </span>
<a name="l00200"></a>00200 <span class="preprocessor"></span>        FM_WORKFLASH_IF-&gt;WFASZR = 0x01u; 
<a name="l00201"></a>00201         u8Dummy = FM_WORKFLASH_IF-&gt;WFASZR;
<a name="l00202"></a>00202 <span class="preprocessor">#endif</span>
<a name="l00203"></a>00203 <span class="preprocessor"></span>    <span class="keywordflow">return</span> emRetValue;
<a name="l00204"></a>00204 }
<a name="l00205"></a>00205 
<a name="l00221"></a><a class="code" href="group___work_flash_group.html#ga1d639a802854c38e71b1d8bf1d099e61">00221</a> en_result_t <a class="code" href="group___work_flash_group.html#ga1d639a802854c38e71b1d8bf1d099e61" title="Flash word write with ECC.">WFlash_WriteData32Bit</a>(uint32_t*  pu32WriteAddr, 
<a name="l00222"></a>00222                                   uint32_t* pu32WriteData, 
<a name="l00223"></a>00223                                   uint32_t u32Size)
<a name="l00224"></a>00224 {
<a name="l00225"></a>00225     uint16_t *pAddr, *pData;
<a name="l00226"></a>00226     en_result_t emRetValue = Ok;
<a name="l00227"></a>00227     uint32_t   u32Cnt;
<a name="l00228"></a>00228 <span class="preprocessor">#if (PDL_MCU_CORE != PDL_FM0P_CORE)   </span>
<a name="l00229"></a>00229 <span class="preprocessor"></span>    uint8_t  u8Dummy;
<a name="l00230"></a>00230 <span class="preprocessor">#endif</span>
<a name="l00231"></a>00231 <span class="preprocessor"></span>    pAddr = (uint16_t*)pu32WriteAddr;
<a name="l00232"></a>00232     pData = (uint16_t*)pu32WriteData;    
<a name="l00233"></a>00233     <span class="comment">/*  CPU programming mode setting    */</span>
<a name="l00234"></a>00234 <span class="preprocessor">#if (PDL_MCU_CORE != PDL_FM0P_CORE)    </span>
<a name="l00235"></a>00235 <span class="preprocessor"></span>    FM_WORKFLASH_IF-&gt;WFASZR = 0x00u;
<a name="l00236"></a>00236     u8Dummy = FM_WORKFLASH_IF-&gt;WFASZR;
<a name="l00237"></a>00237     <span class="keywordflow">if</span>(u8Dummy) ;
<a name="l00238"></a>00238 <span class="preprocessor">#endif</span>
<a name="l00239"></a>00239 <span class="preprocessor"></span>        
<a name="l00240"></a>00240         <span class="keywordflow">for</span>(u32Cnt=u32Size*<span class="keyword">sizeof</span>(uint16_t);u32Cnt;u32Cnt--)
<a name="l00241"></a>00241         {
<a name="l00242"></a>00242             <span class="comment">/*  issue write command   */</span>
<a name="l00243"></a>00243             <a class="code" href="group___work_flash_group.html#ga20eb3b5e3d3a820662d403bf3340abe1" title="Wirte a half word data into Flash.">Flash_Write</a>((<a class="code" href="group___work_flash_group.html#ga47750c7abcf0807643aebd7a8e8c0c26">WFLASH_CODE1</a> | <a class="code" href="group___work_flash_group.html#ga7368f4ecd7d7eeec6eaa974acc7ed729">WFLASH_BASE_ADDR</a>), 0x00AAu) ;
<a name="l00244"></a>00244             <a class="code" href="group___work_flash_group.html#ga20eb3b5e3d3a820662d403bf3340abe1" title="Wirte a half word data into Flash.">Flash_Write</a>((<a class="code" href="group___work_flash_group.html#ga8017917b06bbe0a2da705e3930095a95">WFLASH_CODE2</a> | <a class="code" href="group___work_flash_group.html#ga7368f4ecd7d7eeec6eaa974acc7ed729">WFLASH_BASE_ADDR</a>), 0x0055u) ;
<a name="l00245"></a>00245             <a class="code" href="group___work_flash_group.html#ga20eb3b5e3d3a820662d403bf3340abe1" title="Wirte a half word data into Flash.">Flash_Write</a>((<a class="code" href="group___work_flash_group.html#ga47750c7abcf0807643aebd7a8e8c0c26">WFLASH_CODE1</a> | <a class="code" href="group___work_flash_group.html#ga7368f4ecd7d7eeec6eaa974acc7ed729">WFLASH_BASE_ADDR</a>), 0x00A0u) ;
<a name="l00246"></a>00246             <a class="code" href="group___work_flash_group.html#ga20eb3b5e3d3a820662d403bf3340abe1" title="Wirte a half word data into Flash.">Flash_Write</a>((uint32_t)pAddr, (uint16_t)*pData);
<a name="l00247"></a>00247             
<a name="l00248"></a>00248             <span class="comment">/*  execution result of the automatic algorithm of flash memory is abnormally complete or verify error  */</span>
<a name="l00249"></a>00249             <span class="keywordflow">if</span>(( <a class="code" href="group___work_flash_group.html#ga7a84c85c8623c33d56e1d33145be62ec">WFLASH_CHK_TOGG_ABNORMAL</a> == <a class="code" href="group___work_flash_group.html#ga844335d14336062d28a1bc261471270e" title="automatic algorithm of flash memory execution">WFlash_CheckToggle</a>(pAddr) ) ||
<a name="l00250"></a>00250               ( <a class="code" href="group___work_flash_group.html#ga178452b4e1be4a1f3266ce880a8e0242" title="Read a half word data from Flash.">Flash_Read</a>((uint32_t)pAddr) != (uint16_t)*pData))
<a name="l00251"></a>00251             {
<a name="l00252"></a>00252                 <span class="comment">/*  issue read/reset command to reset sector    */</span>
<a name="l00253"></a>00253                 <a class="code" href="group___work_flash_group.html#gaa7bb4322db632558ad7059e1b60a50ca" title="Issue read/reset command.">WFlash_ReadResetCmd</a>(pAddr) ;
<a name="l00254"></a>00254     
<a name="l00255"></a>00255                 <span class="comment">/*  return flash operation abnormally   */</span>
<a name="l00256"></a>00256                 emRetValue  = ErrorInvalidParameter ;
<a name="l00257"></a>00257             }      
<a name="l00258"></a>00258             <span class="comment">/* Prepare next h-word write */</span>
<a name="l00259"></a>00259             pAddr++;
<a name="l00260"></a>00260             pData++; 
<a name="l00261"></a>00261         }
<a name="l00262"></a>00262         
<a name="l00263"></a>00263         <span class="comment">/*  CPU ROM mode setting    */</span>
<a name="l00264"></a>00264 <span class="preprocessor">#if (PDL_MCU_CORE != PDL_FM0P_CORE) </span>
<a name="l00265"></a>00265 <span class="preprocessor"></span>        FM_WORKFLASH_IF-&gt;WFASZR = 0x01u; 
<a name="l00266"></a>00266         u8Dummy = FM_WORKFLASH_IF-&gt;WFASZR;
<a name="l00267"></a>00267 <span class="preprocessor">#endif</span>
<a name="l00268"></a>00268 <span class="preprocessor"></span>    <span class="keywordflow">return</span> emRetValue ;
<a name="l00269"></a>00269 }
<a name="l00285"></a><a class="code" href="group___work_flash_group.html#ga8ee34360863dd9bb497cf6ae7a830acb">00285</a> en_result_t <a class="code" href="group___work_flash_group.html#ga8ee34360863dd9bb497cf6ae7a830acb" title="Flash half-word write with ECC.">WFlash_WriteData16Bit</a>(uint16_t*  pu16WriteAddr, 
<a name="l00286"></a>00286                                   uint16_t* pu16WriteData, 
<a name="l00287"></a>00287                                   uint32_t u32Size)
<a name="l00288"></a>00288 {
<a name="l00289"></a>00289     en_result_t emRetValue = Ok;
<a name="l00290"></a>00290     uint32_t   u32Cnt;
<a name="l00291"></a>00291 <span class="preprocessor">#if (PDL_MCU_CORE != PDL_FM0P_CORE)   </span>
<a name="l00292"></a>00292 <span class="preprocessor"></span>    uint8_t  u8Dummy;
<a name="l00293"></a>00293 <span class="preprocessor">#endif</span>
<a name="l00294"></a>00294 <span class="preprocessor"></span>
<a name="l00295"></a>00295         <span class="comment">/*  CPU programming mode setting    */</span>
<a name="l00296"></a>00296 <span class="preprocessor">#if (PDL_MCU_CORE != PDL_FM0P_CORE)    </span>
<a name="l00297"></a>00297 <span class="preprocessor"></span>    FM_WORKFLASH_IF-&gt;WFASZR = 0x00u;
<a name="l00298"></a>00298     u8Dummy = FM_WORKFLASH_IF-&gt;WFASZR;
<a name="l00299"></a>00299     <span class="keywordflow">if</span>(u8Dummy) ;
<a name="l00300"></a>00300 <span class="preprocessor">#endif</span>
<a name="l00301"></a>00301 <span class="preprocessor"></span>        
<a name="l00302"></a>00302         <span class="keywordflow">for</span>(u32Cnt=u32Size;u32Cnt;u32Cnt--)
<a name="l00303"></a>00303         {
<a name="l00304"></a>00304             <span class="comment">/*  issue write command   */</span>
<a name="l00305"></a>00305             <a class="code" href="group___work_flash_group.html#ga20eb3b5e3d3a820662d403bf3340abe1" title="Wirte a half word data into Flash.">Flash_Write</a>((<a class="code" href="group___work_flash_group.html#ga47750c7abcf0807643aebd7a8e8c0c26">WFLASH_CODE1</a> | <a class="code" href="group___work_flash_group.html#ga7368f4ecd7d7eeec6eaa974acc7ed729">WFLASH_BASE_ADDR</a>), 0x00AA) ;
<a name="l00306"></a>00306             <a class="code" href="group___work_flash_group.html#ga20eb3b5e3d3a820662d403bf3340abe1" title="Wirte a half word data into Flash.">Flash_Write</a>((<a class="code" href="group___work_flash_group.html#ga8017917b06bbe0a2da705e3930095a95">WFLASH_CODE2</a> | <a class="code" href="group___work_flash_group.html#ga7368f4ecd7d7eeec6eaa974acc7ed729">WFLASH_BASE_ADDR</a>), 0x0055) ;
<a name="l00307"></a>00307             <a class="code" href="group___work_flash_group.html#ga20eb3b5e3d3a820662d403bf3340abe1" title="Wirte a half word data into Flash.">Flash_Write</a>((<a class="code" href="group___work_flash_group.html#ga47750c7abcf0807643aebd7a8e8c0c26">WFLASH_CODE1</a> | <a class="code" href="group___work_flash_group.html#ga7368f4ecd7d7eeec6eaa974acc7ed729">WFLASH_BASE_ADDR</a>), 0x00A0) ;
<a name="l00308"></a>00308             <a class="code" href="group___work_flash_group.html#ga20eb3b5e3d3a820662d403bf3340abe1" title="Wirte a half word data into Flash.">Flash_Write</a>(pu16WriteAddr, (uint16_t)*pu16WriteData);
<a name="l00309"></a>00309             
<a name="l00310"></a>00310             <span class="comment">/*  execution result of the automatic algorithm of flash memory is abnormally complete or verify error  */</span>
<a name="l00311"></a>00311             <span class="keywordflow">if</span>(( <a class="code" href="group___work_flash_group.html#ga7a84c85c8623c33d56e1d33145be62ec">WFLASH_CHK_TOGG_ABNORMAL</a> == <a class="code" href="group___work_flash_group.html#ga844335d14336062d28a1bc261471270e" title="automatic algorithm of flash memory execution">WFlash_CheckToggle</a>(pu16WriteAddr) ) ||
<a name="l00312"></a>00312               ( <a class="code" href="group___work_flash_group.html#ga178452b4e1be4a1f3266ce880a8e0242" title="Read a half word data from Flash.">Flash_Read</a>(pu16WriteAddr) != *pu16WriteData))
<a name="l00313"></a>00313             {
<a name="l00314"></a>00314                 <span class="comment">/*  issue read/reset command to reset sector    */</span>
<a name="l00315"></a>00315                 <a class="code" href="group___work_flash_group.html#gaa7bb4322db632558ad7059e1b60a50ca" title="Issue read/reset command.">WFlash_ReadResetCmd</a>(pu16WriteAddr) ;
<a name="l00316"></a>00316     
<a name="l00317"></a>00317                 <span class="comment">/*  return flash operation abnormally   */</span>
<a name="l00318"></a>00318                 emRetValue  = ErrorInvalidParameter ;
<a name="l00319"></a>00319             }      
<a name="l00320"></a>00320             <span class="comment">/* Prepare next h-word write */</span>
<a name="l00321"></a>00321             pu16WriteAddr++;
<a name="l00322"></a>00322             pu16WriteData++; 
<a name="l00323"></a>00323         }
<a name="l00324"></a>00324         
<a name="l00325"></a>00325         <span class="comment">/*  CPU ROM mode setting    */</span>
<a name="l00326"></a>00326 <span class="preprocessor">#if (PDL_MCU_CORE != PDL_FM0P_CORE) </span>
<a name="l00327"></a>00327 <span class="preprocessor"></span>        FM_WORKFLASH_IF-&gt;WFASZR = 0x01u; 
<a name="l00328"></a>00328         u8Dummy = FM_WORKFLASH_IF-&gt;WFASZR;
<a name="l00329"></a>00329 <span class="preprocessor">#endif</span>
<a name="l00330"></a>00330 <span class="preprocessor"></span>    <span class="keywordflow">return</span> emRetValue ;
<a name="l00331"></a>00331 }
<a name="l00345"></a><a class="code" href="group___work_flash_group.html#ga844335d14336062d28a1bc261471270e">00345</a> <span class="keyword">static</span> uint8_t <a class="code" href="group___work_flash_group.html#ga844335d14336062d28a1bc261471270e" title="automatic algorithm of flash memory execution">WFlash_CheckToggle</a>( uint16_t* pu16Addr )
<a name="l00346"></a>00346 {
<a name="l00347"></a>00347     uint16_t   u16SequenceFlag1, u16SequenceFlag2 ;  <span class="comment">/*  hardware sequence flag */</span>
<a name="l00348"></a>00348     uint8_t   u8RetValue  = <a class="code" href="group___work_flash_group.html#gaf235e61981f8a0ad277a84f8ba43f333">WFLASH_CHK_TOGG_NORMAL</a> ;
<a name="l00349"></a>00349 
<a name="l00350"></a>00350     <span class="comment">/* set hardware sequence flag */</span>
<a name="l00351"></a>00351     u16SequenceFlag1 = <a class="code" href="group___work_flash_group.html#ga178452b4e1be4a1f3266ce880a8e0242" title="Read a half word data from Flash.">Flash_Read</a>(pu16Addr) ;
<a name="l00352"></a>00352     u16SequenceFlag2 = <a class="code" href="group___work_flash_group.html#ga178452b4e1be4a1f3266ce880a8e0242" title="Read a half word data from Flash.">Flash_Read</a>(pu16Addr) ;
<a name="l00353"></a>00353     <span class="comment">/*  if automatic algorithm is executing */</span>
<a name="l00354"></a>00354     <span class="keywordflow">while</span>(<a class="code" href="group___work_flash_group.html#ga1b42d2964e6be57415871ce74620590d">WFLASH_CHK_TOGG_MASK</a> == (( u16SequenceFlag1 ^ u16SequenceFlag2) &amp; <a class="code" href="group___work_flash_group.html#ga1b42d2964e6be57415871ce74620590d">WFLASH_CHK_TOGG_MASK</a>))
<a name="l00355"></a>00355     {
<a name="l00356"></a>00356         <span class="comment">/*  if exceeds the timing limit */</span>
<a name="l00357"></a>00357         <span class="keywordflow">if</span>(<a class="code" href="group___work_flash_group.html#ga21359999f3aa327ea544ce167dd09fbc">WFLASH_CHK_TLOV_MASK</a> == ( u16SequenceFlag1 &amp; <a class="code" href="group___work_flash_group.html#ga21359999f3aa327ea544ce167dd09fbc">WFLASH_CHK_TLOV_MASK</a> ) )
<a name="l00358"></a>00358         {
<a name="l00359"></a>00359             <span class="comment">/* set hardware sequence flag */</span>
<a name="l00360"></a>00360             u16SequenceFlag1 = <a class="code" href="group___work_flash_group.html#ga178452b4e1be4a1f3266ce880a8e0242" title="Read a half word data from Flash.">Flash_Read</a>(pu16Addr) ;
<a name="l00361"></a>00361             u16SequenceFlag2 = <a class="code" href="group___work_flash_group.html#ga178452b4e1be4a1f3266ce880a8e0242" title="Read a half word data from Flash.">Flash_Read</a>(pu16Addr) ;
<a name="l00362"></a>00362 
<a name="l00363"></a>00363             <span class="comment">/*  if automatic algorithm is executing */</span>
<a name="l00364"></a>00364             <span class="keywordflow">if</span>(WFLASH_CHK_TOGG_MASK == (( u16SequenceFlag1 ^ u16SequenceFlag2) &amp; WFLASH_CHK_TOGG_MASK))
<a name="l00365"></a>00365             {
<a name="l00366"></a>00366                 <span class="comment">/*  abnormally complete */</span>
<a name="l00367"></a>00367                 u8RetValue  = <a class="code" href="group___work_flash_group.html#ga7a84c85c8623c33d56e1d33145be62ec">WFLASH_CHK_TOGG_ABNORMAL</a> ;
<a name="l00368"></a>00368 
<a name="l00369"></a>00369                 <span class="keywordflow">break</span>;
<a name="l00370"></a>00370             }
<a name="l00371"></a>00371         }
<a name="l00372"></a>00372 
<a name="l00373"></a>00373         <span class="comment">/* set hardware sequence flag */</span>
<a name="l00374"></a>00374         u16SequenceFlag1 = <a class="code" href="group___work_flash_group.html#ga178452b4e1be4a1f3266ce880a8e0242" title="Read a half word data from Flash.">Flash_Read</a>(pu16Addr) ;
<a name="l00375"></a>00375         u16SequenceFlag2 = <a class="code" href="group___work_flash_group.html#ga178452b4e1be4a1f3266ce880a8e0242" title="Read a half word data from Flash.">Flash_Read</a>(pu16Addr) ;
<a name="l00376"></a>00376     }
<a name="l00377"></a>00377 
<a name="l00378"></a>00378     <span class="keywordflow">return</span> u8RetValue ;
<a name="l00379"></a>00379 }
<a name="l00380"></a>00380 
<a name="l00382"></a>00382 
<a name="l00383"></a>00383 <span class="preprocessor">#endif</span>
<a name="l00384"></a>00384 <span class="preprocessor"></span>
<a name="l00385"></a>00385 <span class="comment">/******************************************************************************/</span>
<a name="l00386"></a>00386 <span class="comment">/* EOF (not truncated)                                                        */</span>
<a name="l00387"></a>00387 <span class="comment">/******************************************************************************/</span>
</pre></div></div><!-- contents -->
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="workflash_8c.html">workflash.c</a>      </li>

    <li class="footer">Generated on Tue Sep 29 2015 15:06:40 for PDL for FM Family by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
